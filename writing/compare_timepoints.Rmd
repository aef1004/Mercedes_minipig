---
title: "Compare_timepoints"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message = FALSE}
library(data.table)
library(openCyto)
library(ncdfFlow)
library(flowWorkspace)
library(dplyr)
library(ggcyto)
library(stringr) 
library(scales)
library(tidyr)
library(superheat)
library(tibble)
library(pheatmap)
library(cytotypr)
library(gridExtra)
library(factoextra)
library(ggplot2)
library(rstatix)
library(purrr)
library(tidyr)
library(broom)
library(ggsignif)
library(ggpubr)
```

```{r}

load("../data/all_fe_30DPI")
load("../data/all_fe_12week")

all_fe_30DPI
all_fe_12week

all_fe <- rbind(all_fe_12week, all_fe_30DPI)
```

# Singular marker expression

```{r}
single_expression <- all_fe %>%
  gather(key = marker, value = expression, -filename, -cell_no, -total_count_by_file, -percentage)%>%
  group_by(filename, marker, expression) %>%
  summarise(cells_per_marker = sum(cell_no)) %>%
  ungroup() %>%
  group_by(filename, marker) %>%
  mutate(total_cells = sum(cells_per_marker),
         percent_per_marker = 100*cells_per_marker/total_cells) %>%
  ungroup() %>%
  mutate(timepoint = str_extract(filename, "[:alpha:]+[:digit:]+"),
         filename = str_extract(filename, "Pig [0-9]*")) %>%
  mutate(vaccine_status = ifelse(filename == "Pig 9947" | filename == "Pig 1817" | filename == "Pig 6059" | filename == "Pig 4515"| filename == "Pig 5273", "vaccinated", "control"))

# shape for vaccine status
single_expression %>%
  filter(expression == "1") %>%
    mutate(timepoint = str_replace(timepoint, "Week12", "Pre-infection"),
         timepoint = str_replace(timepoint, "D30", "Post-infection")) %>%
  rename(Timepoint = timepoint) %>%
  mutate(`Vaccine Status` = factor(vaccine_status)) %>%
  ggplot(aes(x =factor(Timepoint, levels = c("Pre-infection", "Post-infection")),
             shape = `Vaccine Status`, y = percent_per_marker, color = Timepoint)) +
  scale_shape_manual(c(1, 16)) +
  geom_point() +
  facet_wrap(~marker) +
  scale_shape_manual(values = c(21,19)) +
  labs(x = "Timepoint", y = "Percent of Cells Expressing the Marker") +
  ggtitle("")


# paired with shape for vaccine status
single_expression %>%
  filter(expression == "1") %>%
    mutate(timepoint = str_replace(timepoint, "Week12", "Pre-infection"),
         timepoint = str_replace(timepoint, "D30", "Post-infection")) %>%
  rename(Timepoint = timepoint) %>%
  mutate(`Vaccine Status` = factor(vaccine_status)) %>%
  ggplot(aes(x =factor(Timepoint, levels = c("Pre-infection", "Post-infection")),
             shape = `Vaccine Status`, y = percent_per_marker, color = Timepoint)) +
  geom_point() +
  geom_line(aes(group = filename), color = "black", alpha = 0.5) +
  facet_wrap(~marker) +
  scale_shape_manual(values = c(21,19)) +
  labs(x = "Timepoint", y = "Percent of Cells Expressing the Marker") +
  ggtitle("")


single_expression %>%
  filter(expression == "1") %>%
    mutate(timepoint = str_replace(timepoint, "Week12", "Pre-infection"),
         timepoint = str_replace(timepoint, "D30", "Post-infection")) %>%
  rename(Timepoint = timepoint) %>%
  ggplot(aes(x =factor(Timepoint, levels = c("Pre-infection", "Post-infection")), y = percent_per_marker, color = Timepoint)) +
  facet_wrap(~marker) +
  scale_shape_manual(values = c(21,19)) +
  labs(x = "Timepoint", y = "Percent of Cells Expressing the Marker") +
  ggtitle("")

# paired lines
single_expression %>%
  filter(expression == "1") %>%
    mutate(timepoint = str_replace(timepoint, "Week12", "Pre-infection"),
         timepoint = str_replace(timepoint, "D30", "Post-infection")) %>%
  rename(Timepoint = timepoint) %>%
  ggplot(aes(x =factor(Timepoint, levels = c("Pre-infection", "Post-infection")), y = percent_per_marker, color = Timepoint)) +
  geom_point() +
  geom_line(aes(group = filename), color = "grey") +
  facet_wrap(~marker) +
  scale_shape_manual(values = c(21,19)) +
  labs(x = "Timepoint", y = "Percent of Cells Expressing the Marker") +
  ggtitle("")
```

Singular Marker Statistical Significance

There are no differences between the BCG and PBS groups or the two timepoints
```{r}
# compare BCG to PBS
single_expression %>%
  filter(expression == "1") %>%
  group_by(timepoint, marker) %>%
  do(tidy(t.test(percent_per_marker ~ vaccine_status, data = .))) %>%
  filter(p.value < 0.05)

single_expression %>%
  filter(expression == "1") %>%
  group_by(timepoint, marker) %>%
  do(tidy(wilcox.test(percent_per_marker ~ vaccine_status, data = ., paired = TRUE))) %>%
  filter(p.value < 0.05)

single_expression %>%
  filter(expression == "1") %>%
  group_by(timepoint, marker) %>%
  nest() %>%
  mutate(aov_result = map(data, ~aov(percent_per_marker ~ vaccine_status, data = .x)),
         tukey_result = map(aov_result, TukeyHSD),
         tidy_tukey = map(tukey_result, tidy)) %>%
  unnest(tidy_tukey, .drop = TRUE) %>%
  dplyr::filter(adj.p.value <0.05) %>%
  select(timepoint, marker, contrast, adj.p.value) 



# compare Week 12 to D30
single_expression %>%
  filter(expression == "1") %>%
  group_by(marker) %>%
  do(tidy(t.test(percent_per_marker ~ timepoint, data = ., 
                 paired = TRUE))) %>%
  filter(p.value < 0.05)

single_expression %>%
  filter(expression == "1") %>%
  group_by(marker) %>%
  do(tidy(wilcox.test(percent_per_marker ~ timepoint, data = ., 
                 paired = TRUE))) %>%
  filter(p.value < 0.05)


single_expression %>%
  filter(expression == "1") %>%
  group_by(marker) %>%
  nest() %>%
  mutate(aov_result = map(data, ~aov(percent_per_marker ~ timepoint, data = .x)),
         tukey_result = map(aov_result, TukeyHSD),
         tidy_tukey = map(tukey_result, tidy)) %>%
  unnest(tidy_tukey, .drop = TRUE) %>%
  dplyr::filter(adj.p.value <0.05) %>%
  select(marker, contrast, adj.p.value)
```


# Predefined Phenotypes

Look at specific phenotypes (double negative, CD4+ CD8+ and double positive)
```{r}

save_for_phenotypes <- all_fe %>%
  mutate(filename = str_replace(filename, "_Surface_Control_[0-9]*.fcs", ""),
         timepoint = str_extract(filename, "[:alnum:]*_"),
         timepoint = str_replace(timepoint, "_", ""),
         filename = str_extract(filename, "Pig [0-9]*")) %>%
  mutate(vaccine_status = ifelse(filename == "Pig 9947" | filename == "Pig 1817" | filename == "Pig 6059" | filename == "Pig 4515"| filename == "Pig 5273", "vaccinated", "control"))



# look at specific phenotypes (multiple markers)
look_multiple_markers <- function(df, marker, pheno_name) {
  #marker = as.name(marker) # because calling a specific marker
  
  marker_alone <- maker_percent<- NULL # because creating a new column
  
  df %>%
    dplyr::rename(group = vaccine_status) %>%
    group_by(group, filename, timepoint) %>%
    filter_(marker) %>%
    mutate(marker_alone = sum(cell_no)) %>%
    select(group, filename, timepoint, marker_alone, total_count_by_file) %>%
    unique() %>%
    mutate(marker_percent = 100*marker_alone/total_count_by_file) %>%
  ungroup() %>%
  select(group, filename, timepoint, marker_percent) %>%
    mutate(phenotype = pheno_name)
}


# CD4
pheno_1 <- look_multiple_markers(save_for_phenotypes, c("CD3 == 1 & CD4 == 1 & CD8 == 0"), "CD4_Tcell")

pheno_2 <- look_multiple_markers(save_for_phenotypes, c("CD3 == 1 & CD4 == 0 & CD8 == 1"), "CD8_Tcell")

pheno_3 <- look_multiple_markers(save_for_phenotypes, c("CD3 == 1 & CD4 == 0 & CD8 == 0"), "DN_Tcell")

pheno_4 <- look_multiple_markers(save_for_phenotypes, c("CD3 == 1 & CD4 == 1 & CD8 == 1"), "DP_Tcell")


all_phenotypes <- rbind(pheno_1, pheno_2, pheno_3, pheno_4)

all_phenotypes %>%
  mutate(phenotype = str_replace(phenotype, "CD4_Tcell", "CD4 Tcell"),
         phenotype = str_replace(phenotype, "CD8_Tcell", "CD8 Tcell"),
         phenotype = str_replace(phenotype, "DN_Tcell", "Double Negative (CD4- CD8-) Tcell"),
         phenotype = str_replace(phenotype, "DP_Tcell", "Double Positive (CD4+ CD8+) Tcell")) %>%
  mutate(timepoint = str_replace(timepoint, "Week12", "Pre-infection"),
         timepoint = str_replace(timepoint, "D30DPI", "Post-infection")) %>%
  rename(Timepoint = timepoint) %>%
  ggplot(aes(x = factor(Timepoint, levels = c("Pre-infection", "Post-infection")), 
                           y = marker_percent, color = Timepoint)) +
  geom_point() +
  facet_wrap(~phenotype)+
  labs(x = "Timepoint", y = "Percent of Cells with the Phenotype") +
  ggtitle("")

# with shapes for vaccine status
all_phenotypes %>%
  mutate(phenotype = str_replace(phenotype, "CD4_Tcell", "CD4 Tcell (CD4+ CD8-)"),
         phenotype = str_replace(phenotype, "CD8_Tcell", "CD8 Tcell (CD4- CD8+)"),
         phenotype = str_replace(phenotype, "DN_Tcell", "Double Negative Tcell (CD4- CD8-)"),
         phenotype = str_replace(phenotype, "DP_Tcell", "Double Positive Tcell (CD4+ CD8+)")) %>%
  mutate(timepoint = str_replace(timepoint, "Week12", "Pre-infection"),
         timepoint = str_replace(timepoint, "D30DPI", "Post-infection")) %>%
  rename(Timepoint = timepoint) %>%
  mutate(`Vaccine Status` = factor(group)) %>%
  ggplot(aes(x = factor(Timepoint, levels = c("Pre-infection", "Post-infection")), 
                           y = marker_percent, color = Timepoint, shape = `Vaccine Status`)) +
  scale_shape_manual(values = c(1, 16)) +
  geom_point() +
  facet_wrap(~phenotype)+
  labs(x = "Timepoint", y = "Percent of Cells with the Phenotype") +
  ggtitle("")

```

Predefined statistical analysis

There are no differences between the BCG and PBS groups, but there are differences in the CD4+ T cells and DN T cells
```{r}
# compare BCG to PBS
all_phenotypes %>%
  group_by(timepoint, phenotype) %>%
  do(tidy(t.test(marker_percent ~ group, data = .))) %>%
  filter(p.value < 0.05)

all_phenotypes %>%
  group_by(timepoint, phenotype) %>%
    nest() %>%
  mutate(aov_result = map(data, ~aov(marker_percent ~ group, data = .x)),
         tukey_result = map(aov_result, TukeyHSD),
         tidy_tukey = map(tukey_result, tidy)) %>%
  unnest(tidy_tukey, .drop = TRUE) %>%
  dplyr::filter(adj.p.value <0.05) %>%
  select(phenotype, timepoint, contrast, adj.p.value)

# compare Week 12 to D30
all_phenotypes %>%
  group_by(phenotype) %>%
  do(tidy(t.test(marker_percent ~ timepoint, data = .,
                 paired = TRUE))) %>%
  filter(p.value < 0.05)

all_phenotypes %>%
  group_by(phenotype)  %>%
  nest() %>%
  mutate(aov_result = map(data, ~aov(marker_percent ~ timepoint, data = .x)),
         tukey_result = map(aov_result, TukeyHSD),
         tidy_tukey = map(tukey_result, tidy)) %>%
  unnest(tidy_tukey, .drop = TRUE) %>%
  dplyr::filter(adj.p.value <0.05) %>%
  select(phenotype, contrast, adj.p.value)
```

# Feature Engineered Populations

Initial identification of populations plot

We first want to view all of the different cell phenotypes within the data
```{r}
# this is the order of markers that we want for all of our plots
order_of_markers <- c("CD3", "CD4", "CD8", "CD45RA", "SLADQ", "CD172")

# to view all of the possible combinations
total_phenotypes <- filter_for_total_pheno(all_fe, marker_order = order_of_markers)

heatmap_all_pheno(total_phenotypes)

# gives the total number of populations
nrow(total_phenotypes) 
```

After identifying all phenotypes, we can filter the data to see the ones that we’re interested in, for example, CD3+ cells that constitute >0.5% of total live leukocytes in a sample.


```{r fig.height=2, fig.width = 1}
# view the specific cell phenotypes we're interested in
sample_populations <- all_fe %>%
  dplyr::filter(CD3 == 1 & percentage > 1) %>%
  arrange(CD3, CD4, CD8) %>%
  filter_pops() 

correct_order <- c(paste0("Pop", c(1:length(unique(sample_populations$population)))))

sample_populations_all_groups <- identified_pop_perc(sample_populations, all_fe, 
                                                     marker_vector = order_of_markers) %>%
  mutate(filename = str_replace(filename, "_Surface_Control_[0-9]*.fcs", ""),
         timepoint = str_extract(filename, "[:alnum:]*_"),
         timepoint = str_replace(timepoint, "_", ""),
         filename = str_extract(filename, "Pig [0-9]*")) %>%
  mutate(vaccine_status = ifelse(filename == "Pig 9947" | filename == "Pig 1817" | filename == "Pig 6059" | filename == "Pig 4515"| filename == "Pig 5273", "vaccinated", "control")) %>%
  mutate(population = factor(population, levels = correct_order))

simple_pop_df <- sample_populations %>%
  column_to_rownames("population") 

simple_pop_df %>%
  dplyr::select(all_of(order_of_markers)) %>%
  mutate_all(~convert_factor_numeric(.)) %>%
    pheatmap::pheatmap(cluster_rows = FALSE, cluster_cols = FALSE,
             labels_row = rownames(simple_pop_df),
             cellwidth = 15, cellheight = 15, angle_col = 45, 
             color = c("#3F4788FF", "#56C667FF"), cutree_rows = 2, legend = FALSE)
```

Correlation Plot
```{r}
#corr <- calc_corr(sample_populations_all_groups)

#melted_corr <- format_corr(corr)
  
#plot_corr(melted_corr) +
    # ggplot2::xlab("Populations") +
    # ggplot2::ylab("Populations") +
    # ggplot2::labs(fill = "Correlation") 
```

Look at percentages 
**Note I need to separate out the time and vaccine status (4 groups)
```{r fig.width = 3, fig.height = 4}

sample_populations_all_groups %>%
    mutate(timepoint = str_replace(timepoint, "Week12", "Pre"),
         timepoint = str_replace(timepoint, "D30DPI", "Post")) %>%
  rename(Timepoint = timepoint) %>%
ggplot(aes(x = factor(Timepoint, levels = c("Pre", "Post")), y = percentage, 
                                   group = Timepoint, color = Timepoint)) +
  scale_fill_identity() +
  geom_point(size = 2) +
  facet_wrap("population", scales = "free") +
  xlab("Timepoint") +
  ylab("Percent of Total Live Leukocytes") +
  theme_gray() +
  theme(axis.text = element_text(size = 10),
        strip.text = element_text(size = 10),
        axis.title = element_text(size = 14))


# scatter plot with shape for vaccine status
sample_populations_all_groups %>%
    mutate(timepoint = str_replace(timepoint, "Week12", "Pre"),
         timepoint = str_replace(timepoint, "D30DPI", "Post")) %>%
  rename(Timepoint = timepoint) %>%
  mutate(`Vaccine Status` = factor(vaccine_status)) %>%
ggplot(aes(x = factor(Timepoint, levels = c("Pre", "Post")), y = percentage, 
                                   group = Timepoint, color = Timepoint, shape = `Vaccine Status`)) +
  scale_fill_identity() +
  scale_shape_manual(values = c(1, 16)) +
  geom_point(size = 3) +
  facet_wrap("population", scales = "free") +
  xlab("Timepoint") +
  ylab("Percent of Total Live Leukocytes") +
  theme_gray() +
  theme(axis.text = element_text(size = 12),
        strip.text = element_text(size = 12),
        axis.title = element_text(size = 16))


pops_for_plots_average <- sample_populations_all_groups %>%
  dplyr::group_by(population, vaccine_status) %>%
  dplyr::summarise(average_percent = mean(percentage))

ggplot(pops_for_plots_average, aes(x = vaccine_status, y = average_percent, 
                                   group = vaccine_status, color = vaccine_status)) +
  scale_fill_identity() +
  geom_bar(stat = "identity") +
  facet_wrap("population", scales = "free",  labeller = label_both) +
  xlab("Vaccinate Status") +
  ylab("Average Percent of Total Live Leukocytes") +
  theme_gray() 

pops_for_average_timepoint <- sample_populations_all_groups %>%
  dplyr::group_by(population, timepoint) %>%
  dplyr::summarise(average_percent = mean(percentage))

pops_for_average_timepoint %>%
  mutate(timepoint = str_replace(timepoint, "Week12", "Pre-infection"),
         timepoint = str_replace(timepoint, "D30PI", "Post-infection")) %>%
  rename(Timepoint = timepoint) %>%
ggplot(aes(x = Timepoint, y = average_percent, 
                                   group = Timepoint, color = Timepoint)) +
  scale_fill_identity() +
  geom_bar(stat = "identity") +
  facet_wrap("population", scales = "free",  labeller = label_both) +
  xlab("Vaccinate Status") +
  ylab("Average Percent of Total Live Leukocytes") +
  theme_gray() 

```

Anova and Tukey HSD

There are differences between the timepoints

**Note I might actually want to do a paired analysis here...**
```{r}
# BCG v. PBS
sample_populations_all_groups %>%
  group_by(population, timepoint) %>%
  nest() %>%
  mutate(aov_result = map(data, ~aov(percentage ~ vaccine_status, data = .x)),
         tukey_result = map(aov_result, TukeyHSD),
         tidy_tukey = map(tukey_result, tidy)) %>%
  unnest(tidy_tukey, .drop = TRUE) %>%
  dplyr::filter(adj.p.value <0.05) %>%
  select(timepoint, population, contrast, adj.p.value) %>%
  ungroup()

sample_populations_all_groups %>%
  group_by(population, timepoint) %>%
  nest() %>%
  mutate(wilcox_result = map(data, ~wilcox.test(percentage ~ vaccine_status, 
                                                data = .x, paired = TRUE)),
         tidy_wilcox = map(wilcox_result, tidy)) %>%
  unnest(tidy_wilcox, .drop = TRUE) %>%
  dplyr::filter(p.value <0.05) %>%
  select(timepoint, population, p.value) %>%
  ungroup()

# Pre v post infection
sample_populations_all_groups %>%
  group_by(population) %>%
  nest() %>%
  mutate(aov_result = map(data, ~aov(percentage ~ timepoint, data = .x)),
         tukey_result = map(aov_result, TukeyHSD),
         tidy_tukey = map(tukey_result, tidy)) %>%
  unnest(tidy_tukey, .drop = TRUE) %>%
  dplyr::filter(adj.p.value <0.05) %>%
  select(population, contrast, adj.p.value) %>%
  ungroup() 


sample_populations_all_groups %>%
  group_by(population,) %>%
  nest() %>%
  mutate(wilcox_result = map(data, ~wilcox.test(percentage ~ timepoint, 
                                                data = .x, paired = TRUE)),
         tidy_wilcox = map(wilcox_result, tidy)) %>%
  unnest(tidy_wilcox, .drop = TRUE) %>%
  dplyr::filter(p.value <0.05) %>%
  select(population, p.value) %>%
  ungroup()
```

# Explore Metabolomics

```{r}
metabolites <- read.csv("../data/peakTable_Minipig_Vaccinated_Unvaccinated_QC.csv") %>%
  dplyr::rename(metaboliteID = X) %>%
  select(metaboliteID, contains("Minipig")) %>%
  pivot_longer(cols = c(-metaboliteID), names_to = "full_name", values_to = "metabolite_expression")

metabolites %>%
  select(metaboliteID) %>%
  unique()

# there's a probable convergence failure - so try to see if there are metabolites with NAs or 0's - there are no NAs, but there are 427 metabolites for which metabolite expression = 0 - so let's remove those metabolites and see if there are still convergence failrues
remove_metab <- metabolites %>%
  filter(metabolite_expression == "0") %>%
  select(metaboliteID) %>%
  unique()


metabolite_wide <- metabolites %>%
  filter(!grepl("Pooled", full_name)) %>%
  filter(!(metaboliteID %in% remove_metab$metaboliteID)) %>%
  pivot_wider(names_from = "metaboliteID", values_from = "metabolite_expression") %>%
  column_to_rownames("full_name")

```

Combine flow and metabolite data
```{r}
flow_metabolites <- all_phenotypes %>%
  unite("full_name", c(filename, timepoint)) %>%
  mutate(full_name = str_replace(full_name, " ", "_"),
         full_name = str_replace(full_name, "Pig", "Minipig"),
         full_name = str_replace(full_name, "Week12", "12wks"),
         full_name = str_replace(full_name, "D30DPI", "30DPI")) %>%
  left_join(metabolites, by = "full_name") %>%
  mutate(timepoint = str_replace(full_name, "Minipig_[0-9]*_", ""))

fitted_models <- flow_metabolites %>%
  filter(phenotype == "CD4_Tcell") %>%
  group_by(metaboliteID) %>%
  nest() %>%
  mutate(model = map(data, ~lm(marker_percent ~ metabolite_expression, data = .)),
         summary_model = map(model, tidy)) %>%
unnest(summary_model) %>%
  select(metaboliteID, estimate, model) %>%
  mutate(tidy_model = map(model, broom::glance)) %>%
  unnest(tidy_model) %>%
  select(metaboliteID, adj.r.squared, p.value, estimate) %>%
  ungroup()
  

values_for_plot <- fitted_models %>%
  mutate(p.val.adj = p.adjust(p.value, method = "BH", 
                              n = length(fitted_models$p.value))) 

values_for_plot %>%
  mutate("Significance" = p.val.adj < 0.05) %>%
  dplyr::rename("p-value" = p.value,
         "Adjusted p-value" = p.val.adj) 

# Metabolites 663, 666, 863, 867, 1806
save_for_plot <- fitted_models %>%
  filter(adj.r.squared >0.5)

r_labeling <- left_join(save_for_plot, flow_metabolites, by = "metaboliteID") %>%
  group_by(metaboliteID) %>%
  mutate(x_axis_label = min(marker_percent) + (max(marker_percent) - min(marker_percent))/2,
         y_axis_label = ifelse(estimate <= 0, max(metabolite_expression), min(metabolite_expression))) %>%
  select(metaboliteID, group, timepoint, adj.r.squared, p.value, 
         x_axis_label, y_axis_label) %>%
  unique()

# plot after I bring down the number of metabolites to a reasonable number
flow_metabolites %>%
  filter(phenotype == "CD4_Tcell") %>%
  filter(metaboliteID == 663 | metaboliteID == 666 | metaboliteID == 863 | metaboliteID ==867 | metaboliteID ==1806) %>%
ggplot(aes(x = marker_percent, y = metabolite_expression, color = group)) +
  geom_point() +
  geom_smooth(aes(x = marker_percent, y = metabolite_expression), method = "lm", se = FALSE, color = "#3F4788FF") +
  geom_text(data = r_labeling, aes(x = x_axis_label, y = y_axis_label, 
                                   label = paste("r^2 == ",
                                                 round(adj.r.squared, 2))), parse = TRUE) +
  facet_wrap(~metaboliteID, scales = "free_y") +
  ggtitle("Metabolite Correlations with CD4 T Cell Percentages")

values_for_plot %>%
  filter(p.val.adj<0.05)


flow_metabolites %>%
  filter(phenotype == "CD4_Tcell") %>%
  filter(metaboliteID == 663 | metaboliteID == 666 | metaboliteID == 863 | metaboliteID ==867 | metaboliteID ==1806) %>%
ggplot(aes(x = marker_percent, y = metabolite_expression, color = timepoint)) +
  geom_point() +
  geom_smooth(aes(x = marker_percent, y = metabolite_expression), method = "lm", se = FALSE, color = "#3F4788FF") +
  geom_text(data = r_labeling, aes(x = x_axis_label, y = y_axis_label, 
                                   label = paste("r^2 == ",
                                                 round(adj.r.squared, 2))), parse = TRUE) +
  facet_wrap(~metaboliteID, scales = "free_y") +
  ggtitle("Metabolite Correlations with CD4 T Cell Percentages")
```

Explore metabolites
Based on this analysis, we might want to look at metabolite 8
```{r}
metabolite_wide <- metabolites %>%
  filter(!grepl("Pooled", full_name)) %>%
  filter(!(metaboliteID %in% remove_metab$metaboliteID)) %>%
  pivot_wider(names_from = "metaboliteID", values_from = "metabolite_expression") %>%
  column_to_rownames("full_name")

#remove columns with 0 variance because prcomp cannot divide by the standard deviation if it's infinity
which(apply(metabolite_wide, 2, var)==0)
metabolite_wide <- metabolite_wide[ , which(apply(metabolite_wide, 2, var) != 0)]

# when we get above 700 columns, the probable convergence fails
# when I use the "runif" function two chunks below, it works
res.pca <- prcomp(metabolite_wide[1:690], center = TRUE, scale = TRUE)
```


Woohoo! Going to focus on difference between 12 weeks and 30DPI for the metabolites

# look out to the first PCA - could be batch effects - look out to 3 or 4th PCA
```{r}

res_pca_importance <- summary(res.pca)$importance %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate(PC = factor(1:n()))

res_pca_importance %>% 
  ggplot(aes(x = PC, y = `Proportion of Variance`)) + 
  geom_col() + 
  theme_classic()

summary(res.pca)$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:digit:][:digit:][:alpha:]+")) %>% 
  ggplot(aes(x = PC1, y = PC2, color = timepoint)) + 
  geom_point() + 
  geom_text(aes(label = name), size = 2, vjust = -1) + 
  stat_ellipse() + 
  theme_classic() +
  ggtitle("Metabolite PCA")

summary(res.pca)$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:digit:][:digit:][:alpha:]+")) %>% 
  mutate(vaccine_status = ifelse(name == "Minipig_9947_12wks" | name == "Minipig_9947_30DPI"| name == "Minipig_1817_12wks" | name == "Minipig_6059_12wks" | name == "Minipig_4515_12wks"| name == "Minipig_5273_12wks"| name == "Minipig_1817_30DPI" | name == "Minipig_6059_30DPI" | name == "Minipig_4515_30DPI"| name == "Minipig_5273_30DPI", "vaccinated", "control")) %>%
  mutate(timepoint_vaccine = paste(timepoint," ", vaccine_status)) %>%
  ggplot(aes(x = PC1, y = PC2, color = timepoint_vaccine)) + 
  geom_point() + 
  geom_text(aes(label = name), size = 2, vjust = -1) + 
  stat_ellipse() + 
  theme_classic() +
  ggtitle("Metabolite PCA")
```

Since I can't run all of the metabolites at once, I want to pick out a random grouping of the variables and ensure that the PCA plots look somewhat similar each time


Probable convergence issue is for ggplot - it's okay to have that error, can run with all of the metabolites
```{r}

# picks 690 random metabolites/columns to run through the PCA
metab_run <- metabolite_wide[, floor(runif(690, min = 1, max = ncol(metabolite_wide)))] %>%
  t()


metab_run <-metabolite_wide

res.pca <- prcomp(metab_run, center = TRUE, scale = TRUE)

res_pca_importance <- summary(res.pca)$importance %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate(PC = factor(1:n()))

res_pca_importance %>% 
  ggplot(aes(x = PC, y = `Proportion of Variance`)) + 
  geom_col() + 
  theme_classic()

summary(res.pca)$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:digit:][:digit:][:alpha:]+")) %>% 
  ggplot(aes(x = PC1, y = PC2)) + 
  geom_point() + 
  geom_text(aes(label = name), size = 2, vjust = -1) + 
  stat_ellipse() + 
  theme_classic() +
  ggtitle("Metabolite PCA by Timepoint")


summary(res.pca)$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:digit:][:digit:][:alpha:]+")) %>% 
  mutate(vaccine_status = ifelse(name == "Minipig_9947_12wks" | name == "Minipig_9947_30DPI"| name == "Minipig_1817_12wks" | name == "Minipig_6059_12wks" | name == "Minipig_4515_12wks"| name == "Minipig_5273_12wks"| name == "Minipig_1817_30DPI" | name == "Minipig_6059_30DPI" | name == "Minipig_4515_30DPI"| name == "Minipig_5273_30DPI", "vaccinated", "control")) %>%
  ggplot(aes(x = PC1, y = PC2, color = vaccine_status)) + 
  geom_point() + 
  geom_text(aes(label = name), size = 2, vjust = -1) + 
  stat_ellipse() + 
  scale_color_manual(values = c("#009E73", "purple")) +
  theme_classic() +
  ggtitle("Metabolite PCA by Vaccine Status")

# pretty for write up

summary(res.pca)$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:digit:][:digit:][:alpha:]+")) %>% 
  ggplot(aes(x = PC1, y = PC2, color = timepoint)) + 
  geom_point() + 
  stat_ellipse() + 
  theme_classic() +
    labs(x = paste0("PC1: ", round(res_pca_importance$`Proportion of Variance`[1]*100, 1), "%"),
       y = paste0("PC2: ", round(res_pca_importance$`Proportion of Variance`[2]*100, 1), "%")) +
  ggtitle("Metabolite PCA by Timepoint")


res.pca$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:digit:][:digit:][:alpha:]+")) %>% 
  mutate(vaccine_status = ifelse(name == "Minipig_9947_12wks" | name == "Minipig_9947_30DPI"| name == "Minipig_1817_12wks" | name == "Minipig_6059_12wks" | name == "Minipig_4515_12wks"| name == "Minipig_5273_12wks"| name == "Minipig_1817_30DPI" | name == "Minipig_6059_30DPI" | name == "Minipig_4515_30DPI"| name == "Minipig_5273_30DPI", "vaccinated", "control")) %>%
  ggplot(aes(x = PC1, y = PC2, color = vaccine_status)) + 
  geom_point() + 
  stat_ellipse() + 
  scale_color_manual(values = c("#009E73", "purple")) +
  theme_classic() +
  labs(x = paste0("PC1: ", round(res_pca_importance$`Proportion of Variance`[1]*100, 1), "%"),
       y = paste0("PC2: ", round(res_pca_importance$`Proportion of Variance`[2]*100, 1), "%")) +
  ggtitle("Metabolite PCA by Vaccine Status")






res.pca$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:digit:][:digit:][:alpha:]+")) %>% 
  mutate(vaccine_status = ifelse(name == "Minipig_9947_12wks" | name == "Minipig_9947_30DPI"| name == "Minipig_1817_12wks" | name == "Minipig_6059_12wks" | name == "Minipig_4515_12wks"| name == "Minipig_5273_12wks"| name == "Minipig_1817_30DPI" | name == "Minipig_6059_30DPI" | name == "Minipig_4515_30DPI"| name == "Minipig_5273_30DPI", "vaccinated", "control")) %>%
  mutate(timepoint_vaccine = paste(timepoint," ", vaccine_status)) %>%
  ggplot(aes(x = PC1, y = PC2, color = timepoint_vaccine)) +
  geom_point() + 
  stat_ellipse() + 
  theme_classic() +
  labs(x = paste0("PC1: ", round(res_pca_importance$`Proportion of Variance`[1]*100, 1), "%"),
       y = paste0("PC2: ", round(res_pca_importance$`Proportion of Variance`[2]*100, 1), "%")) +
  ggtitle("Metabolite PCA")

 
PCA_minipig <- res.pca$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:digit:][:digit:][:alpha:]+")) %>% 
  mutate(vaccine_status = ifelse(name == "Minipig_9947_12wks" | name == "Minipig_9947_30DPI"| name == "Minipig_1817_12wks" | name == "Minipig_6059_12wks" | name == "Minipig_4515_12wks"| name == "Minipig_5273_12wks"| name == "Minipig_1817_30DPI" | name == "Minipig_6059_30DPI" | name == "Minipig_4515_30DPI"| name == "Minipig_5273_30DPI", "vaccinated", "control")) %>%
  mutate(timepoint_vaccine = paste(timepoint," ", vaccine_status)) 


```

```{r}
test_metabolite <-metabolite_wide %>%
  t()


res.pca <- prcomp(test_metabolite, center = TRUE, scale = TRUE, tol = sqrt(.Machine$double.eps))

res_pca_importance <- summary(res.pca)$importance %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate(PC = factor(1:n()))

res.pca$x
summary(res.pca)$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:digit:][:digit:][:alpha:]+")) %>% 
  ggplot(aes(x = PC1, y = PC2)) + 
  geom_point() + 
  geom_text(aes(label = name), size = 2, vjust = -1) + 
  stat_ellipse() + 
  theme_classic() +
  ggtitle("Metabolite PCA by Timepoint")


summary(res.pca)$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:digit:][:digit:][:alpha:]+")) %>% 
  mutate(vaccine_status = ifelse(name == "Minipig_9947_12wks" | name == "Minipig_9947_30DPI"| name == "Minipig_1817_12wks" | name == "Minipig_6059_12wks" | name == "Minipig_4515_12wks"| name == "Minipig_5273_12wks"| name == "Minipig_1817_30DPI" | name == "Minipig_6059_30DPI" | name == "Minipig_4515_30DPI"| name == "Minipig_5273_30DPI", "vaccinated", "control")) %>%
  ggplot(aes(x = PC1, y = PC2, color = vaccine_status)) + 
  geom_point() + 
  geom_text(aes(label = name), size = 2, vjust = -1) + 
  stat_ellipse() + 
  scale_color_manual(values = c("#009E73", "purple")) +
  theme_classic() +
  ggtitle("Metabolite PCA by Vaccine Status")

# pretty for write up

summary(res.pca)$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:digit:][:digit:][:alpha:]+")) %>% 
  ggplot(aes(x = PC1, y = PC2, color = timepoint)) + 
  geom_point() + 
  stat_ellipse() + 
  theme_classic() +
    labs(x = paste0("PC1: ", round(res_pca_importance$`Proportion of Variance`[1]*100, 1), "%"),
       y = paste0("PC2: ", round(res_pca_importance$`Proportion of Variance`[2]*100, 1), "%")) +
  ggtitle("Metabolite PCA by Timepoint")


res.pca$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:digit:][:digit:][:alpha:]+")) %>% 
  mutate(vaccine_status = ifelse(name == "Minipig_9947_12wks" | name == "Minipig_9947_30DPI"| name == "Minipig_1817_12wks" | name == "Minipig_6059_12wks" | name == "Minipig_4515_12wks"| name == "Minipig_5273_12wks"| name == "Minipig_1817_30DPI" | name == "Minipig_6059_30DPI" | name == "Minipig_4515_30DPI"| name == "Minipig_5273_30DPI", "vaccinated", "control")) %>%
  ggplot(aes(x = PC1, y = PC2, color = vaccine_status)) + 
  geom_point() + 
  stat_ellipse() + 
  scale_color_manual(values = c("#009E73", "purple")) +
  theme_classic() +
  labs(x = paste0("PC1: ", round(res_pca_importance$`Proportion of Variance`[1]*100, 1), "%"),
       y = paste0("PC2: ", round(res_pca_importance$`Proportion of Variance`[2]*100, 1), "%")) +
  ggtitle("Metabolite PCA by Vaccine Status")


```

30DPI PCA - just check that there aren't differences between vacc and non-vacc
```{r}
# picks 690 random metabolites/columns to run through the PCA
metab_run <- metabolite_wide[, floor(runif(690, min = 1, max = ncol(metabolite_wide)))] %>%
  rownames_to_column("sample") %>%
  filter(grepl("30DPI", sample)) %>%
  column_to_rownames("sample")

res.pca <- prcomp(metab_run, center = TRUE, scale = TRUE, tol = sqrt(.Machine$double.eps))

res_pca_importance <- summary(res.pca)$importance %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate(PC = factor(1:n()))

res_pca_importance %>% 
  ggplot(aes(x = PC, y = `Proportion of Variance`)) + 
  geom_col() + 
  theme_classic()

summary(res.pca)$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:digit:][:digit:][:alpha:]+")) %>% 
  ggplot(aes(x = PC1, y = PC2, color = timepoint)) + 
  geom_point() + 
  geom_text(aes(label = name), size = 2, vjust = -1) + 
  stat_ellipse() + 
  theme_classic() +
  ggtitle("Metabolite PCA by Timepoint")


summary(res.pca)$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:digit:][:digit:][:alpha:]+")) %>% 
  mutate(vaccine_status = ifelse(name == "Minipig_9947_12wks" | name == "Minipig_9947_30DPI"| name == "Minipig_1817_12wks" | name == "Minipig_6059_12wks" | name == "Minipig_4515_12wks"| name == "Minipig_5273_12wks"| name == "Minipig_1817_30DPI" | name == "Minipig_6059_30DPI" | name == "Minipig_4515_30DPI"| name == "Minipig_5273_30DPI", "vaccinated", "control")) %>%
  ggplot(aes(x = PC1, y = PC2, color = vaccine_status)) + 
  geom_point() + 
  geom_text(aes(label = name), size = 2, vjust = -1) + 
  stat_ellipse() + 
  scale_color_manual(values = c("#009E73", "purple")) +
  theme_classic() +
  ggtitle("Metabolite PCA by Vaccine Status")

```



All major flow phenotypes
```{r}
major_phenos_pca <- all_phenotypes %>%
  pivot_wider(names_from = "phenotype", values_from = "marker_percent") %>% 
  unite("name", c(filename, group, timepoint), sep = "_") %>%
  column_to_rownames("name") %>%
  prcomp(center = TRUE, scale = TRUE)

major_phenos_importance <- summary(major_phenos_pca)$importance %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate(PC = factor(1:n()))

major_phenos_importance %>% 
  ggplot(aes(x = PC, y = `Proportion of Variance`)) + 
  geom_col() + 
  theme_classic()


summary(major_phenos_pca)$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:alpha:]+[:digit:][:digit:]")) %>%
  ggplot(aes(x = PC1, y = PC2, color = timepoint)) + 
  geom_point() + 
  stat_ellipse() + 
  theme_classic() +
  ggtitle("Flow Major Phenotype")

summary(major_phenos_pca)$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:alpha:]+[:digit:][:digit:]"),
         vaccine_status = str_extract(name, "_[:alpha:]+_")) %>%
  ggplot(aes(x = PC1, y = PC2, color = vaccine_status)) + 
  geom_point() + 
  stat_ellipse() + 
  theme_classic() +
  ggtitle("Flow Major Phenotype")
```

Feature engineered flow phenotypes
```{r}
flow_fe_pca <- sample_populations_all_groups %>%
  pivot_wider(names_from = "population", values_from = "percentage") %>% 
  unite("name", c(filename, vaccine_status, timepoint), sep = "_") %>%
  column_to_rownames("name") %>%
  prcomp(center = TRUE, scale = TRUE)

flow_fe_importance <- summary(flow_fe_pca)$importance %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate(PC = factor(1:n()))

flow_fe_importance %>% 
  ggplot(aes(x = PC, y = `Proportion of Variance`)) + 
  geom_col() + 
  theme_classic()

summary(flow_fe_pca )$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:alpha:]+[:digit:][:digit:]"),
         vaccine_status = str_extract(name, "_[:alpha:]+_")) %>%
  ggplot(aes(x = PC1, y = PC2, color = timepoint)) + 
  geom_point() + 
  stat_ellipse() + 
  theme_classic() +
  ggtitle("Flow Feature Engineered Phenotypes")

summary(flow_fe_pca )$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:alpha:]+[:digit:][:digit:]"),
         vaccine_status = str_extract(name, "_[:alpha:]+_")) %>%
  ggplot(aes(x = PC1, y = PC2, color = vaccine_status)) + 
  geom_point() + 
  stat_ellipse() + 
  theme_classic() +
  ggtitle("Flow Feature Engineered Phenotypes")
```

Single Expression Flow
```{r}
single_flow_pca <- single_expression %>%
  filter(expression == "1") %>%
  select(timepoint, vaccine_status, filename, marker, percent_per_marker) %>%
  pivot_wider(names_from = "marker", values_from = "percent_per_marker") %>% 
  unite("name", c(filename, vaccine_status, timepoint), sep = "_") %>%
  column_to_rownames("name") %>%
  prcomp(center = TRUE, scale = TRUE)

single_flow_importance <- summary(single_flow_pca)$importance %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate(PC = factor(1:n()))

single_flow_importance %>% 
  ggplot(aes(x = PC, y = `Proportion of Variance`)) + 
  geom_col() + 
  theme_classic()

summary(single_flow_pca )$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:alpha:]+[:digit:][:digit:]"),
         vaccine_status = str_extract(name, "_[:alpha:]+_")) %>%
  ggplot(aes(x = PC1, y = PC2, color = timepoint)) + 
  geom_point() + 
  stat_ellipse() + 
  theme_classic() +
  ggtitle("Single Expression Phenotypes")

summary(single_flow_pca )$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:alpha:]+[:digit:][:digit:]"),
         vaccine_status = str_extract(name, "_[:alpha:]+_")) %>%
  ggplot(aes(x = PC1, y = PC2, color = vaccine_status)) + 
  geom_point() + 
  stat_ellipse() + 
  theme_classic() +
  ggtitle("Single Expression Phenotypes")

res.var <- get_pca_var(single_flow_pca)
res.var

res.var$contrib # contains the contributions (in percentage) of the variables to the principal components
```

Okay so at this point, let's see if there are correlations with specific markers 

```{r fig.width = 7, fig.height = 8}

single_expression_metabolites <- single_expression %>%
  filter(expression == "1") %>%
  unite("full_name", c(filename, timepoint)) %>%
  mutate(full_name = str_replace(full_name, " ", "_"),
         full_name = str_replace(full_name, "Pig", "Minipig"),
         full_name = str_replace(full_name, "Week12", "12wks"),
         full_name = str_replace(full_name, "D30", "30DPI")) %>%
  left_join(metabolites, by = "full_name") %>%
  mutate(timepoint = str_extract(full_name, "[:digit:]+[:alpha:]+"))

fitted_models <- single_expression_metabolites %>%
  filter(marker == "SLADQ") %>%
  group_by(metaboliteID) %>%
  nest() %>%
  mutate(model = map(data, ~lm(percent_per_marker ~ metabolite_expression, data = .)),
         summary_model = map(model, tidy)) %>%
unnest(summary_model) %>%
  filter(term != "(Intercept)") %>%
  select(metaboliteID, estimate, model) %>%
  mutate(tidy_model = map(model, broom::glance)) %>%
  unnest(tidy_model) %>%
  select(metaboliteID, adj.r.squared, estimate, p.value) %>%
  ungroup() 


save_for_plot <-fitted_models %>%
  filter(p.value < 0.01) %>%
  filter(adj.r.squared >0.6 | adj.r.squared < -0.6) 

r_labeling <- left_join(save_for_plot, single_expression_metabolites, by = "metaboliteID") %>%
  group_by(metaboliteID) %>%
  mutate(x_axis_label = min(percent_per_marker) + (max(percent_per_marker) - min(percent_per_marker))/2,
         y_axis_label = ifelse(estimate <= 0, max(metabolite_expression), min(metabolite_expression))) %>%
  select(metaboliteID,  timepoint, adj.r.squared, p.value, 
         x_axis_label, y_axis_label) %>%
  unique()

# plot after I bring down the number of metabolites to a reasonable number
single_expression_metabolites %>%
  filter(marker == "SLADQ") %>%
  filter(metaboliteID %in% save_for_plot$metaboliteID) %>%
ggplot(aes(x = percent_per_marker, y = metabolite_expression, color = factor(timepoint))) +
  geom_point() +
  geom_smooth(aes(x = percent_per_marker, y = metabolite_expression), method = "lm", se = FALSE, color = "#3F4788FF") +
  geom_text(data = r_labeling, aes(x = x_axis_label, y = y_axis_label, 
                                   label = paste("r^2 == ",
                                                 round(adj.r.squared, 2))), parse = TRUE) +
  facet_wrap(~metaboliteID, scales = "free_y") +
  ggtitle("Metabolite Correlations with SLADQ Percentages")



```

Look at SLADQ with the two timepoints separated
```{r fig.width = 7, fig.height = 8}

fitted_models <- single_expression_metabolites %>%
  filter(marker == "SLADQ") %>%
  group_by(metaboliteID, timepoint) %>%
  nest() %>%
  mutate(model = map(data, ~lm(percent_per_marker ~ metabolite_expression, data = .)),
         summary_model = map(model, tidy)) %>%
unnest(summary_model) %>%
  filter(term != "(Intercept)") %>%
  select(metaboliteID, estimate, model) %>%
  mutate(tidy_model = map(model, broom::glance)) %>%
  unnest(tidy_model) %>%
  select(metaboliteID, adj.r.squared, estimate, p.value, timepoint) %>%
  ungroup() 


save_for_plot <-fitted_models %>%
  filter(p.value < 0.05) %>%
  filter(adj.r.squared >0.6 | adj.r.squared < -0.6) 

r_labeling <- left_join(save_for_plot, single_expression_metabolites, by = c("metaboliteID", "timepoint")) %>%
  group_by(metaboliteID, timepoint) %>%
  mutate(x_axis_label = min(percent_per_marker) + (max(percent_per_marker) - min(percent_per_marker))/2,
         y_axis_label = ifelse(estimate <= 0, max(metabolite_expression), min(metabolite_expression))) %>%
  select(metaboliteID,  timepoint, adj.r.squared, p.value, 
         x_axis_label, y_axis_label) %>%
  unique()


single_expression_metabolites %>%
  filter(marker == "SLADQ") %>%
  filter(metaboliteID %in% save_for_plot$metaboliteID) %>%
ggplot(aes(x = percent_per_marker, y = metabolite_expression, color = factor(timepoint), group = timepoint)) +
  geom_point() +
  geom_smooth(aes(x = percent_per_marker, y = metabolite_expression), method = "lm", se = FALSE) +
  geom_text(data = r_labeling, aes(x = x_axis_label, y = y_axis_label, 
                                   label = paste("r^2 == ",
                                                 round(adj.r.squared, 2))), parse = TRUE) +
  facet_wrap(~metaboliteID, scales = "free_y") +
  ggtitle("Metabolite Correlations with SLADQ Percentages")
```


Histogram of P-values (SLADQ correlation with metabolites)
```{r}

# page 153 in the biological textbook
# we would expect to see a uniform distribution here if we don't expect anything interesting and don't think there should be any differences

# we take the 0.5 in the calculation of pi0 because we want to see the uniform distribution and if we look too close to our alpha, it will be skewed. Since we're only looking at pvalue >0.5 (or half of the plot) we multiply the 2 to get the total proportion - the FDR is the proportion of values that are falsely picked out as significant

# calculate the FDR (False Discovery Rate)

alpha = binw = 0.01

pi0 <- fitted_models %>%
  mutate(total_rows = nrow(.)) %>%
  filter(p.value >0.5) %>% #
  mutate(pval_0.5 = nrow(.)) %>%
  summarise(pi0 = 2*(pval_0.5/total_rows)) %>%
  unique()

pi1 <- fitted_models %>%
  mutate(total_rows = nrow(.)) %>%
  filter(p.value <=alpha ) %>% #
  mutate(pval_alpha = nrow(.)) %>%
  summarise(pi1= (pval_alpha/total_rows)) %>%
  unique()


ggplot(fitted_models, aes(x = p.value)) +
  geom_histogram(binwidth = binw) +
  geom_vline(xintercept = alpha, color = "red") +
  geom_hline(yintercept = pi0$pi0*binw * nrow(fitted_models), col  = "blue") +
  ggtitle("Metabolite and SLADQ Percentages P-value Histogram")

# calculate the fraction of false rejections
pi0$pi0 * alpha / pi1$pi1
```

look at correlation of the metabolites picked up by the SLADQ correlation

```{r}
SLADQ_corr_metab <- left_join(save_for_plot, single_expression_metabolites, by = "metaboliteID")

cor1 <- SLADQ_corr_metab  %>%
  select(full_name, metaboliteID, metabolite_expression) %>%
  unique() %>%
   tidyr::pivot_wider(names_from = metaboliteID, 
                       values_from = metabolite_expression) %>%
  column_to_rownames("full_name")

  corr <- round(stats::cor(cor1), 1)


melted_corr <- format_corr(corr)
  
plot_corr(melted_corr) +
     ggplot2::xlab("Populations") +
     ggplot2::ylab("Populations") +
     ggplot2::labs(fill = "Correlation") 

#total of 8,836 rows comprised of 94 metabolites
melted_corr %>%
  select(Var1) %>%
  unique()

# 94 different metabolites that are stongly correlated with each other - so that's all of them...
melted_corr %>%
  filter(value >0.8 | value < -0.8) %>%
  select(Var2) %>%
  unique()

melted_corr %>%
  filter(value >0.8 | value < -0.8) %>%
  group_by(Var2) %>%
  unique()

# how do I pull out the different groups at this point..
read.csv("../data/peakTable_Minipig_Vaccinated_Unvaccinated_QC.csv") %>%
  rename(metaboliteID = X) %>%
  filter(metaboliteID =="1348")


melted_corr %>%
  filter(value >0.8 | value < -0.8) 

```

functions for calculating data
```{r fig.width = 7, fig.height = 8}

fit_models <- function(df, markerID, timepoint = FALSE) {  
  if(timepoint == FALSE) {
df %>%
  filter(marker == markerID) %>%
  group_by(metaboliteID) %>%
  nest() %>%
  mutate(model = map(data, ~lm(percent_per_marker ~ metabolite_expression, data = .)),
         summary_model = map(model, tidy)) %>%
unnest(summary_model) %>%
  filter(term != "(Intercept)") %>%
  select(metaboliteID, estimate, model) %>%
  mutate(tidy_model = map(model, broom::glance)) %>%
  unnest(tidy_model) %>%
  select(metaboliteID, adj.r.squared, p.value, estimate) %>%
  ungroup()
    } else {
      
    df %>%
  filter(marker == markerID) %>%
  group_by(metaboliteID, timepoint) %>%
  nest() %>%
  mutate(model = map(data, ~lm(percent_per_marker ~ metabolite_expression, data = .)),
         summary_model = map(model, tidy)) %>%
unnest(summary_model) %>%
  filter(term != "(Intercept)") %>%
  select(metaboliteID, timepoint, estimate, model) %>%
  mutate(tidy_model = map(model, broom::glance)) %>%
  unnest(tidy_model) %>%
  select(metaboliteID, adj.r.squared, estimate, p.value, timepoint) %>%
  ungroup() 
  }
}


calc_important_metab <- function(df, min_p_value, min_r_squared) {

df %>%
  filter(p.value < min_p_value) %>%
  filter(adj.r.squared > min_r_squared)
}

calculate_plot_r_labeling <- function(important_metab, df, timepoint = FALSE) {
  if(timepoint == FALSE) {
    left_join(important_metab, df, by = "metaboliteID") %>%
  group_by(metaboliteID) %>%
  mutate(x_axis_label = min(percent_per_marker) + (max(percent_per_marker) - min(percent_per_marker))/2,
         y_axis_label = ifelse(estimate <= 0, max(metabolite_expression), min(metabolite_expression))) %>%
  select(metaboliteID,  timepoint, adj.r.squared, p.value, 
         x_axis_label, y_axis_label) %>%
  unique()
  } else {
      
  left_join(important_metab, df, by = c("metaboliteID", "timepoint")) %>%
  group_by(metaboliteID, timepoint) %>%
  mutate(x_axis_label = min(percent_per_marker) + (max(percent_per_marker) - min(percent_per_marker))/2,
         y_axis_label = ifelse(estimate <= 0, max(metabolite_expression), min(metabolite_expression))) %>%
  select(metaboliteID,  timepoint, adj.r.squared, p.value, 
         x_axis_label, y_axis_label) %>%
  unique()
  }
}

flow_metab_corr_plot <- function(df, important_metab, markerID, r_labels, timepoint = FALSE) {
  if(timepoint == FALSE) {
      df %>%
  filter(marker == markerID) %>%
  filter(metaboliteID %in% important_metab$metaboliteID) %>%
ggplot(aes(x = percent_per_marker, y = metabolite_expression, color = factor(timepoint))) +
  geom_point() +
  geom_smooth(aes(x = percent_per_marker, y = metabolite_expression), method = "lm", se = FALSE, color = "#3F4788FF") +
  geom_text(data = r_labels, aes(x = x_axis_label, y = y_axis_label, 
                                   label = paste("r^2 == ",
                                                 round(adj.r.squared, 2))), parse = TRUE) +
  facet_wrap(~metaboliteID, scales = "free_y") +
  ggtitle(paste("Metabolite Correlations with", markerID, "Percentages"))
  } else{
      df %>%
  filter(marker == markerID) %>%
  filter(metaboliteID %in% important_metab$metaboliteID) %>%
ggplot(aes(x = percent_per_marker, y = metabolite_expression, color = factor(timepoint), group = timepoint)) +
  geom_point() +
  geom_smooth(aes(x = percent_per_marker, y = metabolite_expression), method = "lm", se = FALSE) +
  geom_text(data = r_labels, aes(x = x_axis_label, y = y_axis_label, 
                                   label = paste("r^2 == ",
                                                 round(adj.r.squared, 2))), parse = TRUE) +
  facet_wrap(~metaboliteID, scales = "free_y") +
  ggtitle(paste("Metabolite Correlations with", markerID, "Percentages"))
  }
}

p_hist <- function(df_fitted_models, markerID) {
  
  alpha = binw = 0.01

pi0 <- df_fitted_models %>%
  mutate(total_rows = nrow(.)) %>%
  filter(p.value >0.5) %>% #
  mutate(pval_0.5 = nrow(.)) %>%
  summarise(pi0 = 2*(pval_0.5/total_rows)) %>%
  unique()

pi1 <- df_fitted_models %>%
  mutate(total_rows = nrow(.)) %>%
  filter(p.value <=alpha ) %>% #
  mutate(pval_alpha = nrow(.)) %>%
  summarise(pi1= (pval_alpha/total_rows)) %>%
  unique()


ggplot(df_fitted_models, aes(x = p.value)) +
  geom_histogram(binwidth = binw) +
  geom_vline(xintercept = alpha, color = "red") +
  geom_hline(yintercept = pi0$pi0*binw * nrow(df_fitted_models), col  = "blue") +
  ggtitle(paste("Metabolite and", markerID, "Percentages P-value Histogram"))
}

```

*General r^2 with the two timepoints combined*
Note: CD8 - no metabolites for which r^2 is >0.5 or < -0.5 and pvalue < 0.05
```{r}
fitted_models_SLADQ <- fit_models(single_expression_metabolites, "SLADQ")
fitted_models_CD172 <- fit_models(single_expression_metabolites, "CD172")
fitted_models_CD8 <- fit_models(single_expression_metabolites, "CD8")
fitted_models_CD4 <- fit_models(single_expression_metabolites, "CD4")
fitted_models_CD3 <- fit_models(single_expression_metabolites, "CD3")

important_metabs_SLADQ <- calc_important_metab(fitted_models_SLADQ, 0.01, 0.5)
important_metabs_CD172 <- calc_important_metab(fitted_models_CD172, 0.01, 0.5)
important_metabs_CD8 <- calc_important_metab(fitted_models_CD8, 0.01, 0.5)
important_metabs_CD4 <- calc_important_metab(fitted_models_CD4, 0.01, 0.5)
important_metabs_CD3 <- calc_important_metab(fitted_models_CD3, 0.01, 0.5)
```

Plot the correlations with timepoints combined
```{r fig.width = 7, fig.height = 8}

r_labels_SLADQ <- calculate_plot_r_labeling(important_metabs_SLADQ, single_expression_metabolites)
r_labels_CD172 <- calculate_plot_r_labeling(important_metabs_CD172, single_expression_metabolites)
r_labels_CD8 <- calculate_plot_r_labeling(important_metabs_CD8, single_expression_metabolites)
r_labels_CD4 <- calculate_plot_r_labeling(important_metabs_CD4, single_expression_metabolites)
r_labels_CD3 <- calculate_plot_r_labeling(important_metabs_CD3, single_expression_metabolites)

flow_metab_corr_plot(single_expression_metabolites, important_metabs_SLADQ, 
                     "SLADQ", r_labels_SLADQ)
flow_metab_corr_plot(single_expression_metabolites, important_metabs_CD172, 
                     "CD172", r_labels_CD172)
#flow_metab_corr_plot(single_expression_metabolites, important_metabs_CD8, 
#                     "CD8", r_labels_CD8) # there are no significant metabolites
flow_metab_corr_plot(single_expression_metabolites, important_metabs_CD3, 
                     "CD3", r_labels_CD3)
flow_metab_corr_plot(single_expression_metabolites, important_metabs_CD4, 
                     "CD4", r_labels_CD4)
```

Look at the p-value histograms
```{r}
p_hist(fitted_models_SLADQ, "SLADQ")
p_hist(fitted_models_CD172, "CD172")
p_hist(fitted_models_CD8, "CD8")
p_hist(fitted_models_CD4, "CD4")
p_hist(fitted_models_CD3, "CD3")
```

*correlations with the timepoints separated*
```{r}
fitted_models_SLADQ_tp <- fit_models(single_expression_metabolites, "SLADQ", TRUE)
fitted_models_CD172_tp <- fit_models(single_expression_metabolites, "CD172", TRUE)
fitted_models_CD8_tp <- fit_models(single_expression_metabolites, "CD8", TRUE)
fitted_models_CD4_tp <- fit_models(single_expression_metabolites, "CD4", TRUE)
fitted_models_CD3_tp <- fit_models(single_expression_metabolites, "CD3", TRUE)

important_metabs_SLADQ_tp <- calc_important_metab(fitted_models_SLADQ_tp, 0.01, 0.5)
important_metabs_CD172_tp <- calc_important_metab(fitted_models_CD172_tp, 0.01, 0.5)
important_metabs_CD8_tp <- calc_important_metab(fitted_models_CD8_tp, 0.01, 0.5)
important_metabs_CD4_tp <- calc_important_metab(fitted_models_CD4_tp, 0.01, 0.5)
important_metabs_CD3_tp <- calc_important_metab(fitted_models_CD3_tp, 0.01, 0.5)
```

*correlations with the timepoints separated*
```{r fig.width = 7, fig.height = 8}

r_labels_SLADQ_tp <- calculate_plot_r_labeling(important_metabs_SLADQ_tp,
                                               single_expression_metabolites, TRUE)
r_labels_CD172_tp <- calculate_plot_r_labeling(important_metabs_CD172_tp,
                                               single_expression_metabolites, TRUE)
r_labels_CD8_tp <- calculate_plot_r_labeling(important_metabs_CD8_tp,
                                             single_expression_metabolites, TRUE)
r_labels_CD4_tp <- calculate_plot_r_labeling(important_metabs_CD4_tp,
                                             single_expression_metabolites, TRUE)
r_labels_CD3_tp <- calculate_plot_r_labeling(important_metabs_CD3_tp,
                                             single_expression_metabolites, TRUE)

flow_metab_corr_plot(single_expression_metabolites, important_metabs_SLADQ_tp, 
                     "SLADQ", r_labels_SLADQ_tp, TRUE)
flow_metab_corr_plot(single_expression_metabolites, important_metabs_CD172_tp, 
                     "CD172", r_labels_CD172_tp, TRUE)
flow_metab_corr_plot(single_expression_metabolites, important_metabs_CD8_tp, 
                     "CD8", r_labels_CD8_tp, TRUE) 
flow_metab_corr_plot(single_expression_metabolites, important_metabs_CD3_tp, 
                     "CD3", r_labels_CD3_tp, TRUE)
flow_metab_corr_plot(single_expression_metabolites, important_metabs_CD4_tp, 
                     "CD4", r_labels_CD4_tp, TRUE)
```

```{r}
p_hist(fitted_models_SLADQ_tp, "SLADQ")
p_hist(fitted_models_CD172_tp, "CD172")
p_hist(fitted_models_CD8_tp, "CD8")
p_hist(fitted_models_CD4_tp, "CD4")
p_hist(fitted_models_CD3_tp, "CD3")
```
# Try to pick out important metabolites for Nurul

I started out by only pulling out the metabolites for which the correlation is >0.5 or <-0.5 and a pvalue of <0.01, but Nurul can only feasible look up close to 100 metabolites. Therefore, I changed the correlation to need to be >0.6 or <-0.6. This reduced the # of metabolites to explore from >500 to 153

Define all of the different datasets to use
```{r}

single_flow_metabolites <-  single_expression_metabolites

predefined_flow_metabolites <- flow_metabolites

fe_flow_metabolites <- sample_populations_all_groups %>%
  unite("full_name", c(filename, timepoint)) %>%
  mutate(full_name = str_replace(full_name, " ", "_"),
         full_name = str_replace(full_name, "Pig", "Minipig"),
         full_name = str_replace(full_name, "Week12", "12wks"),
         full_name = str_replace(full_name, "D30DPI", "30DPI")) %>%
  left_join(metabolites, by = "full_name") 
```

While none of the markers alone are statistically significant in flow, it appears as though there are some differences visually
```{r}

identify_single_metab <- function(df, markerID) {
  
fitted_models <- df %>%
  filter(marker == markerID) %>%
  group_by(metaboliteID) %>%
  nest() %>%
  mutate(model = map(data, ~lm(percent_per_marker ~ metabolite_expression, data = .)),
         summary_model = map(model, tidy)) %>%
unnest(summary_model) %>%
  select(metaboliteID, estimate, model) %>%
  mutate(tidy_model = map(model, broom::glance)) %>%
  unnest(tidy_model) %>%
  select(metaboliteID, adj.r.squared, p.value, estimate) %>%
  ungroup()

save_for_plot <-fitted_models %>%
  filter(p.value < 0.01) %>%
  filter(adj.r.squared >0.7 | adj.r.squared < -0.7) %>%
  select(metaboliteID) %>%
  unique()

print(save_for_plot)
}


CD4_metab <- identify_single_metab(single_flow_metabolites, "CD4")
SLADQ_metab <-identify_single_metab(single_flow_metabolites, "SLADQ")
CD172_metab <-identify_single_metab(single_flow_metabolites, "CD172")
CD45RA_metab <-identify_single_metab(single_flow_metabolites, "CD45RA")


all_single <- rbind(CD4_metab, SLADQ_metab, CD172_metab) %>%
  unique()
```

These are the two that have statistically significant differences in the flow
```{r}
identify_predefined_metab <- function(df, phenotypeID) {
  
fitted_models <- df %>%
  filter(phenotype == phenotypeID) %>%
  group_by(metaboliteID) %>%
  nest() %>%
  mutate(model = map(data, ~lm(marker_percent ~ metabolite_expression, data = .)),
         summary_model = map(model, tidy)) %>%
unnest(summary_model) %>%
  select(metaboliteID, estimate, model) %>%
  mutate(tidy_model = map(model, broom::glance)) %>%
  unnest(tidy_model) %>%
  select(metaboliteID, adj.r.squared, p.value, estimate) %>%
  ungroup()

save_for_plot <-fitted_models %>%
  filter(p.value < 0.01) %>%
  filter(adj.r.squared >0.7 | adj.r.squared < -0.7) %>%
  select(metaboliteID) %>%
  unique()

print(save_for_plot)
}

CD4Tcell_metab <- identify_predefined_metab(predefined_flow_metabolites, "CD4_Tcell")
DNTcell_metab <- identify_predefined_metab(predefined_flow_metabolites, "DN_Tcell")

all_phen <- rbind(CD4Tcell_metab, DNTcell_metab) %>%
  unique()
```

These are populations that have statistically significant differences in the flow
```{r}
identify_predefined_metab <- function(df, populationID) {
  
fitted_models <- df %>%
  filter(population == populationID) %>%
  group_by(metaboliteID) %>%
  nest() %>%
  mutate(model = map(data, ~lm(percentage ~ metabolite_expression, data = .)),
         summary_model = map(model, tidy)) %>%
unnest(summary_model) %>%
  select(metaboliteID, estimate, model) %>%
  mutate(tidy_model = map(model, broom::glance)) %>%
  unnest(tidy_model) %>%
  select(metaboliteID, adj.r.squared, p.value, estimate) %>%
  ungroup()

save_for_plot <-fitted_models %>%
  filter(p.value < 0.01) %>%
  filter(adj.r.squared >0.7 | adj.r.squared < -0.7) %>%
  select(metaboliteID) %>%
  unique()

print(save_for_plot)
}

pop3_metab <- identify_predefined_metab(fe_flow_metabolites, "Pop3")
pop8_metab <- identify_predefined_metab(fe_flow_metabolites, "Pop8")
pop17_metab <- identify_predefined_metab(fe_flow_metabolites, "Pop17")
pop20_metab <- identify_predefined_metab(fe_flow_metabolites, "Pop20")
pop21_metab <- identify_predefined_metab(fe_flow_metabolites, "Pop21")

# pops 21 and 8 had lowish % of cells (<5%)
# Remove pop 3 because it's a DN cell
all_fe_metab <- rbind(pop3_metab, pop17_metab, pop20_metab) %>%
  unique()


rbind(all_fe_metab, all_single)
```

```{r}
interesting_metab <- rbind(all_single, all_phen, all_fe_metab) %>%
  unique() %>%
  left_join(metabolites) %>%
  filter(!grepl("Pooled", full_name))

cor1 <- interesting_metab %>%
   tidyr::pivot_wider(names_from = metaboliteID, 
                       values_from = metabolite_expression) %>%
  column_to_rownames("full_name")

corr <- round(stats::cor(cor1), 1)


melted_corr <- format_corr(corr)
  
plot_corr(melted_corr) +
     ggplot2::xlab("Populations") +
     ggplot2::ylab("Populations") +
     ggplot2::labs(fill = "Correlation") 
```

If I only look at the "interesting" metabolites, it says that there are only 2 clusters...
```{r}
library(factoextra)
library(NbClust)

set.seed(123)

for_cluster <- interesting_metab %>%
  pivot_wider(names_from = "metaboliteID", values_from = "metabolite_expression") %>%
  column_to_rownames("full_name")

# this one looks at the "interesting" metabolites pulled out from correlations
df <- scale(for_cluster)

# this one looks at all of the metabolites
df <- scale(metabolite_wide)


# Elbow method
fviz_nbclust(df, kmeans, method = "wss", nstart = 5) +
  labs(subtitle = "Elbow method")

# Silhouette method
fviz_nbclust(df, kmeans, method = "silhouette")+
  labs(subtitle = "Silhouette method")

# Gap Statistic - this one takes a while to run
# fviz_nbclust(df, kmeans, nstart = 25,  method = "gap_stat", nboot = 500)+
#   labs(subtitle = "Gap statistic method")


# Compute k-means with k = 2
km.res <- kmeans(df, 2, nstart = 25)
```

# Option 2 

Pull out the metabolites where the Week 12 and D30 individually have either both positive or both negative correlations with the flow

p value for at least one timepoint < 0.05
adj.r.square for at least one timepoint >0.5
--> 49 metabolites

p.value <0.05
adj.r.squared for *both* timepoints >0.5
--> 1 metabolite

```{r}

fitted_models <- single_flow_metabolites %>%
  filter(marker == "SLADQ") %>%
  group_by(metaboliteID, timepoint) %>%
  nest() %>%
  mutate(model = map(data, ~lm(percent_per_marker ~ metabolite_expression, data = .)),
         summary_model = map(model, tidy)) %>%
unnest(summary_model) %>%
  filter(term == "metabolite_expression") %>%
  select(metaboliteID, timepoint, estimate, model) %>%
  mutate(tidy_model = map(model, broom::glance)) %>%
  unnest(tidy_model) %>%
  select(metaboliteID, timepoint, adj.r.squared, p.value, estimate) %>%
  ungroup()

save_for_plot <-fitted_models %>%
  filter(p.value < 0.05) %>%
  filter(adj.r.squared > 0.5 | adj.r.squared < -0.5) %>%
  select(metaboliteID) %>%  
  unique() %>%
  left_join(fitted_models, by = c("metaboliteID")) %>%
  mutate(same_sign = ifelse(estimate >0, "pos", "neg")) %>%
  group_by(metaboliteID) 

both_neg <- save_for_plot %>%
  filter_at(vars(same_sign), all_vars(. == "neg")) %>%
  mutate(repeate = duplicated(metaboliteID)) %>%
  filter(repeate == "TRUE") %>%
  select(metaboliteID)

both_pos <- save_for_plot %>%
  filter_at(vars(same_sign), all_vars(. == "pos")) %>%
  mutate(repeate = duplicated(metaboliteID)) %>%
  filter(repeate == "TRUE") %>%
  select(metaboliteID)

same_sign_metab <- rbind(both_neg, both_pos) %>%
  left_join(save_for_plot) %>%
  select(-same_sign)


```





```{r}
############ cluster the minipigs

mydata <- cor1 %>%
  rownames_to_column("full_name") %>%
  pivot_longer(cols = c(-full_name), names_to = "metab", values_to = "metab_values") %>%
  mutate(metab = str_replace(metab, "[0-9]*", paste0("metab_", metab))) %>%
  pivot_wider(names_from = "metab", values_from = "metab_values") %>%
  column_to_rownames("full_name")

# Determine number of clusters
wss <- (nrow(mydata)-1)*sum(apply(mydata,2,var))

for (i in 2:15) wss[i] <- sum(kmeans(mydata,
   centers=i)$withinss)
plot(1:15, wss, type="b", xlab="Number of Clusters",
  ylab="Within groups sum of squares")

kmeans(mydata, 2)


distance <- get_dist(mydata)
fviz_dist(distance, gradient = list(low = "#00AFBB", mid = "white", high = "#FC4E07"))


############ cluster the metabolites
mydata1 <- t(mydata) %>%
  as.data.frame()


# Determine number of clusters
wss <- (nrow(mydata1)-1)*sum(apply(mydata1,2,var))

for (i in 2:20) wss[i] <- sum(kmeans(mydata1,
   centers=i, iter.max = 50)$withinss)
plot(1:20, wss, type="b", xlab="Number of Clusters",
  ylab="Within groups sum of squares")

km2 <- kmeans(mydata1, centers = 2)
km3 <- kmeans(mydata1, centers = 3)
km4 <- kmeans(mydata1, centers = 4,)
km5 <- kmeans(mydata1, centers = 5)

km2[7]
km3[7]
km4[7]
km5[7]

p1 <- fviz_cluster(km2, geom = "point", data = mydata1) + ggtitle("k = 2")
p2 <- fviz_cluster(km3, geom = "point",  data = mydata1) + ggtitle("k = 3")
p3 <- fviz_cluster(km4, geom = "point",  data = mydata1) + ggtitle("k = 4")
p4 <- fviz_cluster(km5, geom = "point",  data = mydata1) + ggtitle("k = 5")

grid.arrange(p1, p2, p3, p4, nrow = 2)

distance <- get_dist(mydata1)
fviz_dist(distance, gradient = list(low = "#00AFBB", mid = "white", high = "#FC4E07"))



########### cluster metabolites after scaling - doesn't seem to make a huge difference
mydata2 <- scale(mydata1)

wss <- (nrow(mydata2)-1)*sum(apply(mydata2,2,var))

for (i in 2:20) wss[i] <- sum(kmeans(mydata2,
   centers=i, iter.max = 50)$withinss)
plot(1:20, wss, type="b", xlab="Number of Clusters",
  ylab="Within groups sum of squares")

km <- kmeans(mydata2, 5)

km[7]
```

ANCOVA

https://www.datanovia.com/en/lessons/ancova-in-r/

Dependent variable: flow population percentages
grouping variable: vaccine status
Covariate: timepoint
```{r}
CD4_t <- all_flow %>%
  select(full_name, vaccine_status, timepoint, CD4_Tcell) %>%
  mutate(full_name = str_replace(full_name, "_12wks", ""))%>%
  mutate(full_name = str_replace(full_name, "_30DPI", "")) %>%
  pivot_wider(names_from = "timepoint", values_from = "CD4_Tcell")


ggscatter(CD4_t , x = "12wks", y = "30DPI", color = "vaccine_status", add = "reg.line") +
  stat_regline_equation(aes(label =  paste(..eq.label.., ..rr.label.., sep = "~~~~"), 
                            color = vaccine_status))


CD4_t %>% 
  anova_test(`30DPI`~ vaccine_status*`12wks`)
#There was homogeneity of regression slopes as the interaction term was not statistically significant, F(1, 6) = 2.58, p = 0.16.

# Fit the model, the covariate goes first
model <- lm(`30DPI` ~ `12wks` + vaccine_status, data = CD4_t)

# Inspect the model diagnostic metrics
model.metrics <- augment(model) %>%
  select(-.hat, -.sigma, -.fitted) # Remove details

head(model.metrics, 3)

# Assess normality of residuals using shapiro wilk test
shapiro_test(model.metrics$.resid)

#The Shapiro Wilk test was not significant (p > 0.05), so we can assume normality of residuals

model.metrics %>% levene_test(.resid ~ vaccine_status)

# The Levene’s test was not significant (p > 0.05), so we can assume homogeneity of the residual variances for all groups.


model.metrics %>% 
  filter(abs(.std.resid) > 3) %>%
  as.data.frame()

# There were no outliers in the data, as assessed by no cases with standardized residuals greater than 3 in absolute value.


res.aov <- CD4_t %>% 
  anova_test(`30DPI` ~ `12wks` * vaccine_status)

get_anova_table(res.aov)


res.aov %>%
  as.data.frame()
```

Try to run ANCOVA on all of the flow pops
```{r}
all_flow %>%
  pivot_longer(cols = c(CD4_Tcell:SLADQ), names_to = "cell", values_to = "percent") %>%
  group_by(Cell) %>%
  anova_test(percent ~ vaccine_status*timepoint) %>%
  filter(`p<.05` == "*")%>%
  mutate(Cell = factor(Cell, levels = c("CD3", "CD4", "CD45RA", "CD172", "SLADQ", 
                                                "DN_Tcell", 
                              "CD4_Tcell", "CD8_Tcell", "Pop1", "Pop3","Pop4","Pop5","Pop6",
                              "Pop7","Pop8","Pop9","Pop10","Pop11","Pop12","Pop13",
                              "Pop14","Pop15","Pop16","Pop17","Pop19","Pop20","Pop21",
                              "Pop22","Pop23","Pop24","Pop25"))) %>%
  arrange(Cell) %>%
  rename(p_value = p) %>%
  select(Cell, Effect, p)
```


