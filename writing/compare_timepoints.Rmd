---
title: "Compare_timepoints"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message = FALSE}
library(data.table)
library(openCyto)
library(ncdfFlow)
library(flowWorkspace)
library(dplyr)
library(ggcyto)
library(stringr) 
library(scales)
library(tidyr)
library(superheat)
library(tibble)
library(pheatmap)
library(cytotypr)
library(gridExtra)
library(factoextra)
```

```{r}

load("../data/all_fe_30DPI")
load("../data/all_fe_12week")

all_fe_30DPI
all_fe_12week

all_fe <- rbind(all_fe_12week, all_fe_30DPI)
```

#Singular marker expression
```{r}
single_expression <- all_fe %>%
  gather(key = marker, value = expression, -filename, -cell_no, -total_count_by_file, -percentage)%>%
  group_by(filename, marker, expression) %>%
  summarise(cells_per_marker = sum(cell_no)) %>%
  ungroup() %>%
  group_by(filename, marker) %>%
  mutate(total_cells = sum(cells_per_marker),
         percent_per_marker = 100*cells_per_marker/total_cells) %>%
  ungroup() %>%
  mutate(timepoint = str_extract(filename, "[:alpha:]+[:digit:]+"),
         filename = str_extract(filename, "Pig [0-9]*")) %>%
  mutate(vaccine_status = ifelse(filename == "Pig 9947" | filename == "Pig 1817" | filename == "Pig 6059" | filename == "Pig 4515"| filename == "Pig 5273", "vaccinated", "control"))

single_expression %>%
  filter(expression == "1") %>%
  ggplot(aes(x =factor(timepoint, levels = c("Week12", "D30")), y = percent_per_marker, color = timepoint)) +
  geom_point() +
  facet_wrap(~marker)
```


# Visulatizations

Initial identification of populations plot

We first want to view all of the different cell phenotypes within the data
```{r}
# this is the order of markers that we want for all of our plots
order_of_markers <- c("CD3", "CD4", "CD8", "CD45RA", "SLADQ", "CD172")

# to view all of the possible combinations
total_phenotypes <- filter_for_total_pheno(all_fe, marker_order = order_of_markers)

heatmap_all_pheno(total_phenotypes)

# gives the total number of populations
nrow(total_phenotypes) 
```

After identifying all phenotypes, we can filter the data to see the ones that weâ€™re interested in, for example, CD3+ cells that constitute >0.5% of total live leukocytes in a sample.


```{r fig.height=2, fig.width = 1}
# view the specific cell phenotypes we're interested in
sample_populations <- all_fe %>%
  dplyr::filter(CD3 == 1 & percentage > 1) %>%
  arrange(CD3, CD4, CD8) %>%
  filter_pops() 

sample_populations_all_groups <- identified_pop_perc(sample_populations, all_fe, 
                                                     marker_vector = order_of_markers) %>%
  mutate(filename = str_replace(filename, "_Surface_Control_[0-9]*.fcs", ""),
         timepoint = str_extract(filename, "[:alnum:]*_"),
         timepoint = str_replace(timepoint, "_", ""),
         filename = str_extract(filename, "Pig [0-9]*")) %>%
  mutate(vaccine_status = ifelse(filename == "Pig 9947" | filename == "Pig 1817" | filename == "Pig 6059" | filename == "Pig 4515"| filename == "Pig 5273", "vaccinated", "control"))

simple_pop_df <- sample_populations %>%
  column_to_rownames("population") 

simple_pop_df %>%
  dplyr::select(all_of(order_of_markers)) %>%
  mutate_all(~convert_factor_numeric(.)) %>%
    pheatmap::pheatmap(cluster_rows = FALSE, cluster_cols = FALSE,
             labels_row = rownames(simple_pop_df),
             cellwidth = 15, cellheight = 15, angle_col = 45, 
             color = c("#3F4788FF", "#56C667FF"), cutree_rows = 2, legend = FALSE)
```

Correlation Plot
```{r}
#corr <- calc_corr(sample_populations_all_groups)

#melted_corr <- format_corr(corr)
  
#plot_corr(melted_corr) +
    # ggplot2::xlab("Populations") +
    # ggplot2::ylab("Populations") +
    # ggplot2::labs(fill = "Correlation") 
```

Look at percentages 
**Note I need to separate out the time and vaccine status (4 groups)
```{r}
ggplot(sample_populations_all_groups, aes(x = timepoint, y = percentage, 
                                   group = vaccine_status, color = vaccine_status)) +
  scale_fill_identity() +
  geom_point() +
  geom_line() +
  facet_wrap("population", scales = "free",  labeller = label_both) +
  xlab("Timepoint") +
  ylab("Average Percent of Total Live Leukocytes") +
  theme_gray() 


pops_for_plots_average <- sample_populations_all_groups %>%
  dplyr::group_by(population, vaccine_status) %>%
  dplyr::summarise(average_percent = mean(percentage))

ggplot(pops_for_plots_average, aes(x = vaccine_status, y = average_percent, 
                                   group = vaccine_status, color = vaccine_status)) +
  scale_fill_identity() +
  geom_bar(stat = "identity") +
  facet_wrap("population", scales = "free",  labeller = label_both) +
  xlab("Vaccinate Status") +
  ylab("Average Percent of Total Live Leukocytes") +
  theme_gray() 

```

Anova and Tukey HSD

There are differences between the timepoints

**Note I might actually want to do a paired analysis here...**
```{r}
library(purrr)
library(tidyr)
library(broom)


sample_populations_all_groups %>%
  unite(group, c(timepoint, vaccine_status)) %>%
  mutate(group = as.factor(group)) %>%
  group_by(population) %>%
  nest() %>%
  mutate(aov_result = map(data, ~aov(percentage ~ group, data = .x)),
         tukey_result = map(aov_result, TukeyHSD),
         tidy_tukey = map(tukey_result, tidy)) %>%
  unnest(tidy_tukey, .drop = TRUE) %>%
  dplyr::filter(adj.p.value <0.05) %>%
  select(population, contrast, adj.p.value) %>%
  arrange(paste0("Pop", c(1:length(adj.p.value))))
```

Look at specific phenotypes (double negative, CD4+ CD8+ and double positive

)
```{r}

save_for_phenotypes <- all_fe %>%
  mutate(filename = str_replace(filename, "_Surface_Control_[0-9]*.fcs", ""),
         timepoint = str_extract(filename, "[:alnum:]*_"),
         timepoint = str_replace(timepoint, "_", ""),
         filename = str_extract(filename, "Pig [0-9]*")) %>%
  mutate(vaccine_status = ifelse(filename == "Pig 9947" | filename == "Pig 1817" | filename == "Pig 6059" | filename == "Pig 4515"| filename == "Pig 5273", "vaccinated", "control"))



# look at specific phenotypes (multiple markers)
look_multiple_markers <- function(df, marker, pheno_name) {
  #marker = as.name(marker) # because calling a specific marker
  
  marker_alone <- maker_percent<- NULL # because creating a new column
  
  df %>%
    rename(group = vaccine_status) %>%
    group_by(group, filename, timepoint) %>%
    filter_(marker) %>%
    mutate(marker_alone = sum(cell_no)) %>%
    select(group, filename, timepoint, marker_alone, total_count_by_file) %>%
    unique() %>%
    mutate(marker_percent = 100*marker_alone/total_count_by_file) %>%
  ungroup() %>%
  select(group, filename, timepoint, marker_percent) %>%
    mutate(phenotype = pheno_name)
}

# CD4
pheno_1 <- look_multiple_markers(save_for_phenotypes, c("CD3 == 1 & CD4 == 1 & CD8 == 0"), "CD4_Tcell")

pheno_2 <- look_multiple_markers(save_for_phenotypes, c("CD3 == 1 & CD4 == 0 & CD8 == 1"), "CD8_Tcell")

pheno_3 <- look_multiple_markers(save_for_phenotypes, c("CD3 == 1 & CD4 == 0 & CD8 == 0"), "DN_Tcell")

pheno_4 <- look_multiple_markers(save_for_phenotypes, c("CD3 == 1 & CD4 == 1 & CD8 == 1"), "DP_Tcell")


all_phenotypes <- rbind(pheno_1, pheno_2, pheno_3, pheno_4)
```

Look at statistical analysis
```{r}

all_phenotypes%>%
  group_by(timepoint, phenotype) %>%
  do(tidy(t.test(marker_percent ~ group, data = .))) %>%
  filter(p.value<0.05)


library(rstatix)

all_phenotypes%>%
  group_by(timepoint, phenotype) %>%
  tukey_hsd(marker_percent ~ group) 

all_phenotypes %>%
  select(-filename) %>%
  unique()


```

Try to tie in some data on metabolomics
```{r}
metabolites <- read.csv("../data/peakTable_Minipig_Vaccinated_Unvaccinated_QC.csv") %>%
  rename(metaboliteID = X) %>%
  select(metaboliteID, contains("Minipig")) %>%
  pivot_longer(cols = c(-metaboliteID), names_to = "full_name", values_to = "metabolite_expression")

flow_metabolites <- all_phenotypes %>%
  unite("full_name", c(filename, timepoint)) %>%
  mutate(full_name = str_replace(full_name, " ", "_"),
         full_name = str_replace(full_name, "Pig", "Minipig"),
         full_name = str_replace(full_name, "Week12", "12wks"),
         full_name = str_replace(full_name, "D30DPI", "30DPI")) %>%
  left_join(metabolites, by = "full_name") 



fitted_models <- flow_metabolites %>%
  filter(phenotype == "CD4_Tcell") %>%
  group_by(metaboliteID) %>%
  nest() %>%
  mutate(model = map(data, ~lm(marker_percent ~ metabolite_expression, data = .)),
         summary_model = map(model, tidy)) %>%
unnest(summary_model) %>%
  select(metaboliteID, estimate, model) %>%
  mutate(tidy_model = map(model, broom::glance)) %>%
  unnest(tidy_model) %>%
  select(metaboliteID, adj.r.squared, p.value, estimate) %>%
  ungroup()
  

values_for_plot <- fitted_models %>%
  mutate(p.val.adj = p.adjust(p.value, method = "BH", 
                              n = length(fitted_models$p.value))) 

values_for_plot %>%
  mutate("Significance" = p.val.adj < 0.05) %>%
  rename("p-value" = p.value,
         "Adjusted p-value" = p.val.adj) 

# Metabolites 663, 666, 863, 867, 1806
save_for_plot <- fitted_models %>%
  filter(adj.r.squared >0.5)

r_labeling <- left_join(save_for_plot, flow_metabolites, by = "metaboliteID") %>%
  group_by(metaboliteID) %>%
  mutate(x_axis_label = min(marker_percent) + (max(marker_percent) - min(marker_percent))/2,
         y_axis_label = ifelse(estimate <= 0, max(metabolite_expression), min(metabolite_expression))) %>%
  select(metaboliteID, group, adj.r.squared, p.value, 
         x_axis_label, y_axis_label) %>%
  unique()

# plot after I bring down the number of metabolites to a reasonable number
flow_metabolites %>%
  filter(phenotype == "CD4_Tcell") %>%
  filter(metaboliteID == 663 | metaboliteID == 666 | metaboliteID == 863 | metaboliteID ==867 | metaboliteID ==1806) %>%
ggplot(aes(x = marker_percent, y = metabolite_expression, color = group)) +
  geom_point() +
  geom_smooth(aes(x = marker_percent, y = metabolite_expression), method = "lm", se = FALSE, color = "#3F4788FF") +
  geom_text(data = r_labeling, aes(x = x_axis_label, y = y_axis_label, 
                                   label = paste("r^2 == ",
                                                 round(adj.r.squared, 2))), parse = TRUE) +
  facet_wrap(~metaboliteID, scales = "free_y") +
  ggtitle("Metabolite Correlations with CD4 T Cell Percentages")

values_for_plot %>%
  filter(p.val.adj<0.05)
```

Explore metabolites
Based on this analysis, we might want to look at metabolite 8
```{r}
metabolite_wide <- metabolites %>%
  filter(!grepl("Pooled", full_name)) %>%
  pivot_wider(names_from = "metaboliteID", values_from = "metabolite_expression") %>%
  column_to_rownames("full_name")

#remove columns with 0 variance because prcomp cannot divide by the standard deviation if it's infinity
which(apply(metabolite_wide, 2, var)==0)
metabolite_wide <- metabolite_wide[ , which(apply(metabolite_wide, 2, var) != 0)]

# when we get above 700 columns, the probable convergence fails
res.pca <- prcomp(metabolite_wide[1:690], center = TRUE, scale = TRUE)
```


Woohoo! Going to focus on difference between 12 weeks and 30DPI for the metabolites

# look out to the first PCA - could be batch effects - look out to 3 or 4th PCA
```{r}

res_pca_importance <- summary(res.pca)$importance %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate(PC = factor(1:n()))

res_pca_importance %>% 
  ggplot(aes(x = PC, y = `Proportion of Variance`)) + 
  geom_col() + 
  theme_classic()

summary(res.pca)$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:digit:][:digit:][:alpha:]+")) %>% 
  ggplot(aes(x = PC1, y = PC2, color = timepoint)) + 
  geom_point() + 
  geom_text(aes(label = name), size = 2, vjust = -1) + 
  stat_ellipse() + 
  theme_classic() +
  ggtitle("Metabolite PCA")

summary(res.pca)$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:digit:][:digit:][:alpha:]+")) %>% 
  mutate(vaccine_status = ifelse(name == "Minipig_9947_12wks" | name == "Minipig_9947_30DPI"| name == "Minipig_1817_12wks" | name == "Minipig_6059_12wks" | name == "Minipig_4515_12wks"| name == "Minipig_5273_12wks"| name == "Minipig_1817_30DPI" | name == "Minipig_6059_30DPI" | name == "Minipig_4515_30DPI"| name == "Minipig_5273_30DPI", "vaccinated", "control")) %>%
  ggplot(aes(x = PC1, y = PC2, color = vaccine_status)) + 
  geom_point() + 
  geom_text(aes(label = name), size = 2, vjust = -1) + 
  stat_ellipse() + 
  theme_classic() +
  ggtitle("Metabolite PCA")
```

Since I can't run all of the metabolites at once, I want to pick out a random grouping of the variables and ensure that the PCA plots look somewhat similar each time
```{r}
# picks 690 random metabolites/columns to run through the PCA
metab_run <- metabolite_wide[, floor(runif(690, min = 1, max = ncol(metabolite_wide)))]

res.pca <- prcomp(metab_run, center = TRUE, scale = TRUE, tol = sqrt(.Machine$double.eps))

summary(res.pca)$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:digit:][:digit:][:alpha:]+")) %>% 
  ggplot(aes(x = PC1, y = PC2, color = timepoint)) + 
  geom_point() + 
  geom_text(aes(label = name), size = 2, vjust = -1) + 
  stat_ellipse() + 
  theme_classic() +
  ggtitle("Metabolite PCA")
```



All major flow phenotypes
```{r}
major_phenos_pca <- all_phenotypes %>%
  pivot_wider(names_from = "phenotype", values_from = "marker_percent") %>% 
  unite("name", c(filename, group, timepoint), sep = "_") %>%
  column_to_rownames("name") %>%
  prcomp(center = TRUE, scale = TRUE)

major_phenos_importance <- summary(major_phenos_pca)$importance %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate(PC = factor(1:n()))

major_phenos_importance %>% 
  ggplot(aes(x = PC, y = `Proportion of Variance`)) + 
  geom_col() + 
  theme_classic()


summary(major_phenos_pca)$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:alpha:]+[:digit:][:digit:]")) %>%
  ggplot(aes(x = PC1, y = PC2, color = timepoint)) + 
  geom_point() + 
  stat_ellipse() + 
  theme_classic() +
  ggtitle("Flow Major Phenotype")

summary(major_phenos_pca)$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:alpha:]+[:digit:][:digit:]"),
         vaccine_status = str_extract(name, "_[:alpha:]+_")) %>%
  ggplot(aes(x = PC1, y = PC2, color = vaccine_status)) + 
  geom_point() + 
  stat_ellipse() + 
  theme_classic() +
  ggtitle("Flow Major Phenotype")
```

Feature engineered flow phenotypes
```{r}
flow_fe_pca <- sample_populations_all_groups%>%
  pivot_wider(names_from = "population", values_from = "percentage") %>% 
  unite("name", c(filename, vaccine_status, timepoint), sep = "_") %>%
  column_to_rownames("name") %>%
  prcomp(center = TRUE, scale = TRUE)

flow_fe_importance <- summary(flow_fe_pca)$importance %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate(PC = factor(1:n()))

flow_fe_importance %>% 
  ggplot(aes(x = PC, y = `Proportion of Variance`)) + 
  geom_col() + 
  theme_classic()

summary(flow_fe_pca )$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:alpha:]+[:digit:][:digit:]"),
         vaccine_status = str_extract(name, "_[:alpha:]+_")) %>%
  ggplot(aes(x = PC1, y = PC2, color = timepoint)) + 
  geom_point() + 
  stat_ellipse() + 
  theme_classic() +
  ggtitle("Flow Feature Engineered Phenotypes")

summary(flow_fe_pca )$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:alpha:]+[:digit:][:digit:]"),
         vaccine_status = str_extract(name, "_[:alpha:]+_")) %>%
  ggplot(aes(x = PC1, y = PC2, color = vaccine_status)) + 
  geom_point() + 
  stat_ellipse() + 
  theme_classic() +
  ggtitle("Flow Feature Engineered Phenotypes")
```

Single Expression Flow
```{r}
single_flow_pca <- single_expression %>%
  filter(expression == "1") %>%
  select(timepoint, vaccine_status, filename, marker, percent_per_marker) %>%
  pivot_wider(names_from = "marker", values_from = "percent_per_marker") %>% 
  unite("name", c(filename, vaccine_status, timepoint), sep = "_") %>%
  column_to_rownames("name") %>%
  prcomp(center = TRUE, scale = TRUE)

single_flow_importance <- summary(single_flow_pca)$importance %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate(PC = factor(1:n()))

single_flow_importance %>% 
  ggplot(aes(x = PC, y = `Proportion of Variance`)) + 
  geom_col() + 
  theme_classic()

summary(single_flow_pca )$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:alpha:]+[:digit:][:digit:]"),
         vaccine_status = str_extract(name, "_[:alpha:]+_")) %>%
  ggplot(aes(x = PC1, y = PC2, color = timepoint)) + 
  geom_point() + 
  stat_ellipse() + 
  theme_classic() +
  ggtitle("Single Expression Phenotypes")

summary(single_flow_pca )$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:alpha:]+[:digit:][:digit:]"),
         vaccine_status = str_extract(name, "_[:alpha:]+_")) %>%
  ggplot(aes(x = PC1, y = PC2, color = vaccine_status)) + 
  geom_point() + 
  stat_ellipse() + 
  theme_classic() +
  ggtitle("Single Expression Phenotypes")

res.var <- get_pca_var(single_flow_pca)
res.var

res.var$contrib # contains the contributions (in percentage) of the variables to the principal components
```

Okay so at this point, let's see if there are correlations with specific markers 

```{r fig.width = 7, fig.height = 8}

single_expression_metabolites <- single_expression %>%
  filter(expression == "1") %>%
  unite("full_name", c(filename, timepoint)) %>%
  mutate(full_name = str_replace(full_name, " ", "_"),
         full_name = str_replace(full_name, "Pig", "Minipig"),
         full_name = str_replace(full_name, "Week12", "12wks"),
         full_name = str_replace(full_name, "D30", "30DPI")) %>%
  left_join(metabolites, by = "full_name") %>%
  mutate(timepoint = str_extract(full_name, "[:digit:]+[:alpha:]+"))

fitted_models <- single_expression_metabolites %>%
  filter(marker == "SLADQ") %>%
  group_by(metaboliteID) %>%
  nest() %>%
  mutate(model = map(data, ~lm(percent_per_marker ~ metabolite_expression, data = .)),
         summary_model = map(model, tidy)) %>%
unnest(summary_model) %>%
  filter(term != "(Intercept)") %>%
  select(metaboliteID, estimate, model) %>%
  mutate(tidy_model = map(model, broom::glance)) %>%
  unnest(tidy_model) %>%
  select(metaboliteID, adj.r.squared, estimate, p.value) %>%
  ungroup() 


save_for_plot <-fitted_models %>%
  filter(p.value < 0.5) %>%
  filter(adj.r.squared >0.5 | adj.r.squared < -0.5) 

r_labeling <- left_join(save_for_plot, single_expression_metabolites, by = "metaboliteID") %>%
  group_by(metaboliteID) %>%
  mutate(x_axis_label = min(percent_per_marker) + (max(percent_per_marker) - min(percent_per_marker))/2,
         y_axis_label = ifelse(estimate <= 0, max(metabolite_expression), min(metabolite_expression))) %>%
  select(metaboliteID,  timepoint, adj.r.squared, p.value, 
         x_axis_label, y_axis_label) %>%
  unique()

# plot after I bring down the number of metabolites to a reasonable number
single_expression_metabolites %>%
  filter(marker == "SLADQ") %>%
  filter(metaboliteID %in% save_for_plot$metaboliteID) %>%
ggplot(aes(x = percent_per_marker, y = metabolite_expression, color = factor(timepoint))) +
  geom_point() +
  geom_smooth(aes(x = percent_per_marker, y = metabolite_expression), method = "lm", se = FALSE, color = "#3F4788FF") +
  geom_text(data = r_labeling, aes(x = x_axis_label, y = y_axis_label, 
                                   label = paste("r^2 == ",
                                                 round(adj.r.squared, 2))), parse = TRUE) +
  facet_wrap(~metaboliteID, scales = "free_y") +
  ggtitle("Metabolite Correlations with SLADQ Percentages")

```

Histogram of P-values (SLADQ correlation with metabolites)
```{r}

# page 153 in the biological textbook
# we would expect to see a uniform distribution here if we don't expect anything interesting and don't think there should be any differences

# calculate the FDR (False Discovery Rate)
alpha = binw = 0.05
pi0 <- fitted_models %>%
  filter(p.value >0.5) %>% # I don't understand where this 0.5 came from...
  summarise(pi0= 2*mean(p.value))

pi1 <- fitted_models %>%
  filter(p.value <= alpha) %>%
  summarise(pi1= mean(p.value))


ggplot(fitted_models, aes(x = p.value)) +
  geom_histogram(binwidth = binw) +
  geom_vline(xintercept = alpha, color = "red") +
  geom_hline(yintercept = pi0$pi0*binw * nrow(fitted_models), col  = "blue") +
  ggtitle("Metabolite and SLADQ Percentages P-value Histogram")

# calculate the fraction of false rejections
pi0$pi0 * alpha / pi1$pi1
```

look at correlation of the metabolites picked up by the SLADQ correlation

```{r}
SLADQ_corr_metab <- left_join(save_for_plot, single_expression_metabolites, by = "metaboliteID")

cor1 <- SLADQ_corr_metab  %>%
  select(full_name, metaboliteID, metabolite_expression) %>%
  unique() %>%
   tidyr::pivot_wider(names_from = metaboliteID, 
                       values_from = metabolite_expression) %>%
  column_to_rownames("full_name")

  corr <- round(stats::cor(cor1), 1)


melted_corr <- format_corr(corr)
  
plot_corr(melted_corr) +
     ggplot2::xlab("Populations") +
     ggplot2::ylab("Populations") +
     ggplot2::labs(fill = "Correlation") 

#total of 8,836 rows comprised of 94 metabolites
melted_corr %>%
  select(Var1) %>%
  unique()

# 94 different metabolites that are stongly correlated with each other - so that's all of them...
melted_corr %>%
  filter(value >0.8 | value < -0.8) %>%
  select(Var2) %>%
  unique()

melted_corr %>%
  filter(value >0.8 | value < -0.8) %>%
  group_by(Var2) %>%
  unique()

# how do I pull out the different groups at this point..
read.csv("../data/peakTable_Minipig_Vaccinated_Unvaccinated_QC.csv") %>%
  rename(metaboliteID = X) %>%
  filter(metaboliteID =="1348")


melted_corr %>%
  filter(value >0.8 | value < -0.8) 

```



CD172
```{r fig.width = 7, fig.height = 8}
fitted_models <- single_expression_metabolites %>%
  filter(marker == "CD172") %>%
  group_by(metaboliteID) %>%
  nest() %>%
  mutate(model = map(data, ~lm(percent_per_marker ~ metabolite_expression, data = .)),
         summary_model = map(model, tidy)) %>%
unnest(summary_model) %>%
  select(metaboliteID, estimate, model) %>%
  mutate(tidy_model = map(model, broom::glance)) %>%
  unnest(tidy_model) %>%
  select(metaboliteID, adj.r.squared, p.value, estimate) %>%
  ungroup()


save_for_plot <-fitted_models %>%
  filter(p.value < 0.5) %>%
  filter(adj.r.squared >0.5 | adj.r.squared < -0.5)

r_labeling <- left_join(save_for_plot, single_expression_metabolites, by = "metaboliteID") %>%
  group_by(metaboliteID) %>%
  mutate(x_axis_label = min(percent_per_marker) + (max(percent_per_marker) - min(percent_per_marker))/2,
         y_axis_label = ifelse(estimate <= 0, max(metabolite_expression), min(metabolite_expression))) %>%
  select(metaboliteID,  timepoint, adj.r.squared, p.value, 
         x_axis_label, y_axis_label) %>%
  unique()

# plot after I bring down the number of metabolites to a reasonable number
single_expression_metabolites %>%
  filter(marker == "CD172") %>%
  filter(metaboliteID %in% save_for_plot$metaboliteID) %>%
ggplot(aes(x = percent_per_marker, y = metabolite_expression, color = factor(timepoint))) +
  geom_point() +
  geom_smooth(aes(x = percent_per_marker, y = metabolite_expression), method = "lm", se = FALSE, color = "#3F4788FF") +
  geom_text(data = r_labeling, aes(x = x_axis_label, y = y_axis_label, 
                                   label = paste("r^2 == ",
                                                 round(adj.r.squared, 2))), parse = TRUE) +
  facet_wrap(~metaboliteID, scales = "free_y") +
  ggtitle("Metabolite Correlations with CD172 Percentages")

ggplot(fitted_models, aes(x = p.value)) +
  geom_histogram(binwidth = 0.01) +
  geom_vline(xintercept = 0.05, color = "red") +
  ggtitle("Metabolite and CD172 Percentages P-value Histogram")
```

CD8 - no metabolites for which r^2 is >0.5 or < -0.5 and pvalue < 0.05
```{r fig.width = 3, fig.height = 4}
fitted_models <- single_expression_metabolites %>%
  filter(marker == "CD4") %>%
  group_by(metaboliteID) %>%
  nest() %>%
  mutate(model = map(data, ~lm(percent_per_marker ~ metabolite_expression, data = .)),
         summary_model = map(model, tidy)) %>%
unnest(summary_model) %>%
  select(metaboliteID, estimate, model) %>%
  mutate(tidy_model = map(model, broom::glance)) %>%
  unnest(tidy_model) %>%
  select(metaboliteID, adj.r.squared, p.value, estimate) %>%
  ungroup()


save_for_plot <-fitted_models %>%
  filter(p.value < 0.5) %>%
  filter(adj.r.squared >0.5 | adj.r.squared < -0.5)

r_labeling <- left_join(save_for_plot, single_expression_metabolites, by = "metaboliteID") %>%
  group_by(metaboliteID) %>%
  mutate(x_axis_label = min(percent_per_marker) + (max(percent_per_marker) - min(percent_per_marker))/2,
         y_axis_label = ifelse(estimate <= 0, max(metabolite_expression), min(metabolite_expression))) %>%
  select(metaboliteID,  timepoint, adj.r.squared, p.value, 
         x_axis_label, y_axis_label) %>%
  unique()

# plot after I bring down the number of metabolites to a reasonable number
single_expression_metabolites %>%
  filter(marker == "CD4") %>%
  filter(metaboliteID %in% save_for_plot$metaboliteID) %>%
ggplot(aes(x = percent_per_marker, y = metabolite_expression, color = factor(timepoint))) +
  geom_point() +
  geom_smooth(aes(x = percent_per_marker, y = metabolite_expression), method = "lm", se = FALSE, color = "#3F4788FF") +
  geom_text(data = r_labeling, aes(x = x_axis_label, y = y_axis_label, 
                                   label = paste("r^2 == ",
                                                 round(adj.r.squared, 2))), parse = TRUE) +
  facet_wrap(~metaboliteID, scales = "free_y") +
  ggtitle("Metabolite Correlations with CD4 Percentages")

ggplot(fitted_models, aes(x = p.value)) +
  geom_histogram(binwidth = 0.01) +
  geom_vline(xintercept = 0.05, color = "red") +
  ggtitle("Metabolite and CD4 Percentages P-value Histogram")
```


