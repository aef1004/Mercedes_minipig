---
title: "Compare_timepoints"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

load("../data/all_fe_30DPI")
load("../data/all_fe_12week")

all_fe_30DPI
all_fe_12week

all_fe <- rbind(all_fe_12week, all_fe_30DPI)
```

# Visulatizations

Initial identification of populations plot

We first want to view all of the different cell phenotypes within the data
```{r}
# this is the order of markers that we want for all of our plots
order_of_markers <- c("CD3", "CD4", "CD8", "CD45RA", "SLADQ", "CD172")

# to view all of the possible combinations
total_phenotypes <- filter_for_total_pheno(all_fe, marker_order = order_of_markers)

heatmap_all_pheno(total_phenotypes)

# gives the total number of populations
nrow(total_phenotypes) 
```

After identifying all phenotypes, we can filter the data to see the ones that weâ€™re interested in, for example, CD3+ cells that constitute >0.5% of total live leukocytes in a sample.


```{r fig.height=2, fig.width = 1}
# view the specific cell phenotypes we're interested in
sample_populations <- all_fe %>%
  dplyr::filter(CD3 == 1 & percentage > 1) %>%
  arrange(CD3, CD4, CD8) %>%
  filter_pops() 

sample_populations_all_groups <- identified_pop_perc(sample_populations, all_fe, 
                                                     marker_vector = order_of_markers) %>%
  mutate(filename = str_replace(filename, "_Surface_Control_[0-9]*.fcs", ""),
         timepoint = str_extract(filename, "[:alnum:]*_"),
         timepoint = str_replace(timepoint, "_", ""),
         filename = str_extract(filename, "Pig [0-9]*")) %>%
  mutate(vaccine_status = ifelse(filename == "Pig 9947" | filename == "Pig 1817" | filename == "Pig 6059" | filename == "Pig 4515"| filename == "Pig 5273", "vaccinated", "control"))

simple_pop_df <- sample_populations %>%
  column_to_rownames("population") 

simple_pop_df %>%
  dplyr::select(all_of(order_of_markers)) %>%
  mutate_all(~convert_factor_numeric(.)) %>%
    pheatmap::pheatmap(cluster_rows = FALSE, cluster_cols = FALSE,
             labels_row = rownames(simple_pop_df),
             cellwidth = 15, cellheight = 15, angle_col = 45, 
             color = c("#3F4788FF", "#56C667FF"), cutree_rows = 2, legend = FALSE)
```

Correlation Plot
```{r}
corr <- calc_corr(sample_populations_all_groups)

melted_corr <- format_corr(corr)
  
plot_corr(melted_corr) +
    ggplot2::xlab("Populations") +
    ggplot2::ylab("Populations") +
    ggplot2::labs(fill = "Correlation") 
```

Look at percentages
**Note I need to separate out the time and vaccine status (4 groups)
```{r}
ggplot(sample_populations_all_groups, aes(x = timepoint, y = percentage, 
                                   group = vaccine_status, color = vaccine_status)) +
  scale_fill_identity() +
  geom_point() +
  geom_line() +
  facet_wrap("population", scales = "free",  labeller = label_both) +
  xlab("Timepoint") +
  ylab("Average Percent of Total Live Leukocytes") +
  theme_gray() 


pops_for_plots_average <- sample_populations_all_groups %>%
  dplyr::group_by(population, vaccine_status) %>%
  dplyr::summarise(average_percent = mean(percentage))

ggplot(pops_for_plots_average, aes(x = vaccine_status, y = average_percent, 
                                   group = vaccine_status, color = vaccine_status)) +
  scale_fill_identity() +
  geom_bar(stat = "identity") +
  facet_wrap("population", scales = "free",  labeller = label_both) +
  xlab("Vaccinate Status") +
  ylab("Average Percent of Total Live Leukocytes") +
  theme_gray() 

```

Anova and Tukey HSD

There are differences between the timepoints

**Note I might actually want to do a paired analysis here...**
```{r}
library(purrr)
library(tidyr)
library(broom)


sample_populations_all_groups %>%
  unite(group, c(timepoint, vaccine_status)) %>%
  mutate(group = as.factor(group)) %>%
  group_by(population) %>%
  nest() %>%
  mutate(aov_result = map(data, ~aov(percentage ~ group, data = .x)),
         tukey_result = map(aov_result, TukeyHSD),
         tidy_tukey = map(tukey_result, tidy)) %>%
  unnest(tidy_tukey, .drop = TRUE) %>%
  dplyr::filter(adj.p.value <0.05) %>%
  select(population, contrast, adj.p.value) %>%
  arrange(paste0("Pop", c(1:length(adj.p.value))))
```

Look at specific phenotypes (double negative, CD4+ CD8+ and double positive

)
```{r}

save_for_phenotypes <- all_fe %>%
  mutate(filename = str_replace(filename, "_Surface_Control_[0-9]*.fcs", ""),
         timepoint = str_extract(filename, "[:alnum:]*_"),
         timepoint = str_replace(timepoint, "_", ""),
         filename = str_extract(filename, "Pig [0-9]*")) %>%
  mutate(vaccine_status = ifelse(filename == "Pig 9947" | filename == "Pig 1817" | filename == "Pig 6059" | filename == "Pig 4515"| filename == "Pig 5273", "vaccinated", "control"))



# look at specific phenotypes (multiple markers)
look_multiple_markers <- function(df, marker, pheno_name) {
  #marker = as.name(marker) # because calling a specific marker
  
  marker_alone <- maker_percent<- NULL # because creating a new column
  
  df %>%
    rename(group = vaccine_status) %>%
    group_by(group, filename, timepoint) %>%
    filter_(marker) %>%
    mutate(marker_alone = sum(cell_no)) %>%
    select(group, filename, timepoint, marker_alone, total_count_by_file) %>%
    unique() %>%
    mutate(marker_percent = 100*marker_alone/total_count_by_file) %>%
  ungroup() %>%
  select(group, filename, timepoint, marker_percent) %>%
    mutate(phenotype = pheno_name)
}

# CD4
pheno_1 <- look_multiple_markers(save_for_phenotypes, c("CD3 == 1 & CD4 == 1 & CD8 == 0"), "CD4_Tcell")

pheno_2 <- look_multiple_markers(save_for_phenotypes, c("CD3 == 1 & CD4 == 0 & CD8 == 1"), "CD8_Tcell")

pheno_3 <- look_multiple_markers(save_for_phenotypes, c("CD3 == 1 & CD4 == 0 & CD8 == 0"), "DN_Tcell")

pheno_4 <- look_multiple_markers(save_for_phenotypes, c("CD3 == 1 & CD4 == 1 & CD8 == 1"), "DP_Tcell")


all_phenotypes <- rbind(pheno_1, pheno_2, pheno_3, pheno_4)
```

Look at statistical analysis
```{r}


all_phenotypes%>%
  group_by(timepoint, phenotype) %>%
  do(tidy(t.test(marker_percent ~ group, data = .))) %>%
  filter(p.value<0.05)


library(rstatix)

all_phenotypes%>%
  group_by(timepoint, phenotype) %>%
  tukey_hsd(marker_percent ~ group) 

all_phenotypes %>%
  select(-filename) %>%
  unique()


```

Try to tie in some data on metabolomics
```{r}
metabolites <- read.csv("../data/peakTable_Minipig_Vaccinated_Unvaccinated_QC.csv") %>%
  rename(metaboliteID = X) %>%
  select(metaboliteID, contains("Minipig")) %>%
  pivot_longer(cols = c(-metaboliteID), names_to = "full_name", values_to = "metabolite_expression")

flow_metabolites <- all_phenotypes %>%
  unite("full_name", c(filename, timepoint)) %>%
  mutate(full_name = str_replace(full_name, " ", "_"),
         full_name = str_replace(full_name, "Pig", "Minipig"),
         full_name = str_replace(full_name, "Week12", "12wks"),
         full_name = str_replace(full_name, "D30DPI", "30DPI")) %>%
  left_join(metabolites, by = "full_name") 



fitted_models <- flow_metabolites %>%
  filter(phenotype == "CD4_Tcell") %>%
  group_by(metaboliteID) %>%
  nest() %>%
  mutate(model = map(data, ~lm(marker_percent ~ metabolite_expression, data = .)),
         summary_model = map(model, tidy)) %>%
unnest(summary_model) %>%
  select(metaboliteID, estimate, model) %>%
  mutate(tidy_model = map(model, broom::glance)) %>%
  unnest(tidy_model) %>%
  select(metaboliteID, adj.r.squared, p.value, estimate) %>%
  ungroup()
  

values_for_plot <- fitted_models %>%
  mutate(p.val.adj = p.adjust(p.value, method = "BH", 
                              n = length(fitted_models$p.value))) 

values_for_plot %>%
  mutate("Significance" = p.val.adj < 0.05) %>%
  rename("p-value" = p.value,
         "Adjusted p-value" = p.val.adj) 

# Metabolites 663, 666, 863, 867, 1806
save_for_plot <- fitted_models %>%
  filter(adj.r.squared >0.5)

r_labeling <- left_join(save_for_plot, flow_metabolites, by = "metaboliteID") %>%
  group_by(metaboliteID) %>%
  mutate(x_axis_label = min(marker_percent) + (max(marker_percent) - min(marker_percent))/2,
         y_axis_label = ifelse(estimate <= 0, max(metabolite_expression), min(metabolite_expression))) %>%
  select(metaboliteID, group, adj.r.squared, p.value, 
         x_axis_label, y_axis_label) %>%
  unique()

# plot after I bring down the number of metabolites to a reasonable number
flow_metabolites %>%
  filter(phenotype == "CD4_Tcell") %>%
  filter(metaboliteID == 663 | metaboliteID == 666 | metaboliteID == 863 | metaboliteID ==867 | metaboliteID ==1806) %>%
ggplot(aes(x = marker_percent, y = metabolite_expression, color = group)) +
  geom_point() +
  geom_smooth(aes(x = marker_percent, y = metabolite_expression), method = "lm", se = FALSE, color = "#3F4788FF") +
  geom_text(data = r_labeling, aes(x = x_axis_label, y = y_axis_label, 
                                   label = paste("r^2 == ",
                                                 round(adj.r.squared, 2))), parse = TRUE) +
  facet_wrap(~metaboliteID, scales = "free_y") +
  ggtitle("Metabolite Correlations with CD4 T Cell Percentages")

values_for_plot %>%
  filter(p.val.adj<0.05)
```

