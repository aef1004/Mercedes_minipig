---
title: "PCA_clustering"
author: "Amy Fox"
date: "7/6/2021"
output: html_document
---

This is based on the analysis with Bailey 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message = FALSE}
library(readr)
library(dplyr)
library(tidyverse)
library(broom)
```

```{r}
# removes columns (metabolites) that have 0 variance across the animals
removeZeroVar <- function(df){
  df[, !sapply(df, function(x) min(x) == max(x))]
}
```


Read in data
```{r}
load("../data/flow_predefined_phenotypes.gz")
load("../data/flow_single_expression.gz")
load("../data/flow_fe.gz")

metabolites <- read.csv("../data/peakTable_Minipig_Vaccinated_Unvaccinated_QC.csv") %>%
  dplyr::rename(metaboliteID = X) %>%
  select(metaboliteID, contains("Minipig")) %>%
  pivot_longer(cols = c(-metaboliteID), names_to = "full_name", values_to = "metabolite_expression")

metabolite_wide <- metabolites %>%
  filter(!grepl("Pooled", full_name)) %>%
  pivot_wider(names_from = "metaboliteID", values_from = "metabolite_expression") %>%
  removeZeroVar() %>%
  column_to_rownames("full_name")

match_metabolites <- read.csv("../data/peakTable_Minipig_Vaccinated_Unvaccinated_QC.csv") %>%
  dplyr::rename(metaboliteID = X) 

flow_metab1 <- left_join(flow_predefined_phenotypes, metabolites, by = "full_name") %>%
  rename(percent = marker_percent,
         flow = phenotype,
         vaccine_status = group) 

flow_metab2 <-left_join(flow_fe, metabolites, by = "full_name")%>%
  rename(percent = percentage,
         flow = population)

flow_metab3 <-left_join(flow_single_expression, metabolites, by = "full_name") %>%
  rename(flow = marker)

flow_metab <- rbind(flow_metab1, flow_metab2, flow_metab3) %>%
  mutate(timepoint = str_extract(full_name, "[0-9]*[:alpha:]*$"))

all_flow <- flow_metab %>%
  select(-metaboliteID, -metabolite_expression) %>%
  unique() %>%
  pivot_wider(names_from = flow, values_from = percent)
```

Initial view to show metabolites are correlated
```{r}
# cor1 <- flow_metab   %>%
#   select(full_name, metaboliteID, metabolite_expression) %>%
#   unique() %>%
#    tidyr::pivot_wider(names_from = metaboliteID, 
#                        values_from = metabolite_expression) %>%
#   
#   column_to_rownames("full_name")
# 
# 
#   corr <- round(stats::cor(cor1), 1)
# 
# 
# melted_corr <- format_corr(corr)
#   
# plot_corr(melted_corr) +
#      ggplot2::xlab("Metab") +
#      ggplot2::ylab("Metab") +
#      ggplot2::labs(fill = "Correlation") 
```


PCA and proportion of variance
```{r}
res.pca <- prcomp(metabolite_wide, center = TRUE, scale = TRUE)

res_pca_importance <- summary(res.pca)$importance %>% 
  t() %>% 
  as.data.frame() %>% 
  mutate(PC = factor(1:n()))

res_pca_importance %>% 
  ggplot(aes(x = PC, y = `Proportion of Variance`)) + 
  geom_col() + 
  theme_classic()

PCA_minipig <- res.pca$x %>% 
  as.data.frame() %>% 
  rownames_to_column("name") %>%
  mutate(timepoint = str_extract(name, "[:digit:][:digit:][:alpha:]+")) %>% 
  mutate(vaccine_status = ifelse(name == "Minipig_9947_12wks" | name == "Minipig_9947_30DPI"| name == "Minipig_1817_12wks" | name == "Minipig_6059_12wks" | name == "Minipig_4515_12wks"| name == "Minipig_5273_12wks"| name == "Minipig_1817_30DPI" | name == "Minipig_6059_30DPI" | name == "Minipig_4515_30DPI"| name == "Minipig_5273_30DPI", "vaccinated", "control")) %>%
  mutate(timepoint_vaccine = paste(timepoint," ", vaccine_status)) 

PCA_minipig%>%
  ggplot(aes(x = PC1, y = PC2, color = timepoint_vaccine)) +
  geom_point() + 
  stat_ellipse() +
  theme_classic() +
  labs(x = paste0("PC1: ", round(res_pca_importance$`Proportion of Variance`[1]*100, 1), "%"),
       y = paste0("PC2: ", round(res_pca_importance$`Proportion of Variance`[2]*100, 1), "%")) +
  ggtitle("Metabolite PCA")
```
Correlate PC with flow
```{r}
minipig_PCA <- PCA_minipig %>%
  rename(full_name = name) %>%
  left_join(all_flow, by = c("full_name", "timepoint", "vaccine_status")) %>%
  pivot_longer(c(PC1:PC19), names_to = "PC", values_to = "PC_value") %>%
  pivot_longer(c(CD4_Tcell:SLADQ), names_to = "flow", values_to = "flow_percent")

unique(minipig_PCA$PC)

minipig_PCA %>%
  group_by(PC, flow) %>%
  nest() %>%
  mutate(model = map(data, ~lm(flow_percent ~ PC_value, data = .)),
         summary_model = map(model, tidy)) %>%
unnest(summary_model) %>%
  filter(term != "(Intercept)") %>%
  select(flow, PC, estimate, model) %>%
  mutate(tidy_model = map(model, broom::glance)) %>%
  unnest(tidy_model) %>%
  select(flow, PC, adj.r.squared, p.value, estimate) %>%
  ungroup() %>%
  arrange(desc(adj.r.squared)) %>%
  filter(p.value < 0.05) %>%
  filter(adj.r.squared > .5) %>%
  select(flow,PC, adj.r.squared, p.value) %>%
  unique()


# All with PC2 - pops12, 15, 20, 22, 7, 8, CD172

plot_pick_metab <- function(df, flow_pop, metab_pick, pretty_metab, x_position, yposition1, yposition2) {
  step1 <- df %>%
  filter(flow == flow_pop & PC == metab_pick) %>%
  group_by(PC, flow) %>%
  nest() %>%
  mutate(model = map(data, ~lm(flow_percent ~ PC_value, data = .)),
         summary_model = map(model, tidy)) %>%
unnest(summary_model) %>%
  filter(term != "(Intercept)") %>%
  select(PC, flow, estimate, model) %>%
  mutate(tidy_model = map(model, broom::glance)) %>%
  unnest(tidy_model) %>%
  select(PC, flow, adj.r.squared, p.value, estimate) %>%
  ungroup() %>%
  select(PC, flow, adj.r.squared, p.value) %>%
  unique()

# plot after I bring down the number of metabolites to a reasonable number
df %>%
  filter(flow == flow_pop & PC == metab_pick) %>%
  left_join(step1, by = c("flow", "PC")) %>%
ggplot(aes(x = flow_percent, y = PC_value, color = factor(timepoint))) +
  geom_point(size = 3) +
  geom_smooth(aes(x = flow_percent, y = PC_value), method = "lm", se = FALSE, color = "#3F4788FF") +
  geom_text(aes(x = x_position, y = yposition1, 
                                   label = paste("r^2 == ",
                                                 round(adj.r.squared, 2))), parse = TRUE, color = "black") +
  geom_text(aes(x = x_position, y = yposition2, 
                                   label = paste("p == ",
                                                 signif(p.value, 2))), parse = TRUE, color = "black") +
  ggtitle(pretty_metab) +
  labs(color = "Timepoint", x = paste(flow_pop, "Percentage of Cells"), y = "PC Value", fill = "Timepoint") +
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 18),
        title = element_text(size = 18))
}


plot_pick_metab(minipig_PCA, "Pop7", "PC2", "PC2", 2.5, 50, 25) 
plot_pick_metab(minipig_PCA, "Pop8", "PC2", "PC2", 2.5, 50, 25) 
plot_pick_metab(minipig_PCA, "Pop12", "PC2", "PC2", 2.5, 50, 25) 
plot_pick_metab(minipig_PCA, "Pop15", "PC2", "PC2", 0.5, 50, 25) 
plot_pick_metab(minipig_PCA, "Pop20", "PC2", "PC2", 2.5, 50, 25) 
plot_pick_metab(minipig_PCA, "Pop22", "PC2", "PC2", 2.5, 50, 25) 
plot_pick_metab(minipig_PCA, "CD172", "PC2", "PC2", 2.5, 50, 25) 

plot_pick_metab(minipig_PCA, "Pop10", "PC4", "PC4", 2.5, 50, 25) 
```
So I may actually want to change the model to account for the timepoint

  filter(case_when(y=="" ~ x > 3, #When y == "", x > 3
                   T ~ x<3) 
```{r}
minipig_PCA %>%
  group_by(PC, flow) %>%
  nest() %>%
  mutate(model = map(data, ~lm(flow_percent ~ PC_value *timepoint, data = .)),
         summary_model = map(model, tidy)) %>%
  unnest(summary_model) %>%
  filter(term != "(Intercept)" & term != "timepoint30DPI") %>%
  select(flow, PC, term, p.value) %>%
  filter(case_when(term == "PC_value"	~ p.value <0.05,
                   T ~ p.value >0.05)) %>%
  arrange(flow, PC) %>%
  filter(term == "PC_value")
  
plot_pick_metab <- function(df, flow_pop, metab_pick, pretty_metab, x_position, yposition1, yposition2) {
  step1 <- df %>%
  filter(flow == flow_pop & PC == metab_pick) %>%
  group_by(PC, flow) %>%
  nest() %>%
  mutate(model = map(data, ~lm(flow_percent ~ PC_value, data = .)),
         summary_model = map(model, tidy)) %>%
unnest(summary_model) %>%
  filter(term != "(Intercept)") %>%
  select(PC, flow, estimate, model) %>%
  mutate(tidy_model = map(model, broom::glance)) %>%
  unnest(tidy_model) %>%
  select(PC, flow, adj.r.squared, p.value, estimate) %>%
  ungroup() %>%
  select(PC, flow, adj.r.squared, p.value) %>%
  unique()

# plot after I bring down the number of metabolites to a reasonable number
df %>%
  filter(flow == flow_pop & PC == metab_pick) %>%
  left_join(step1, by = c("flow", "PC")) %>%
ggplot(aes(x = flow_percent, y = PC_value, color = factor(timepoint))) +
  geom_point(size = 3) +
  geom_smooth(aes(x = flow_percent, y = PC_value), method = "lm", se = FALSE, color = "#3F4788FF") +
  ggtitle(pretty_metab) +
  labs(color = "Timepoint", x = paste(flow_pop, "Percentage of Cells"), y = "PC Value", fill = "Timepoint") +
  theme(axis.text = element_text(size = 14),
        axis.title = element_text(size = 18),
        title = element_text(size = 18))
}


plot_pick_metab(minipig_PCA, "CD3", "PC11", "PC11", 75, 5, 10) 
plot_pick_metab(minipig_PCA, "CD3", "PC4", "PC4", 75, 5, 10) 
plot_pick_metab(minipig_PCA, "CD3", "PC5", "PC5", 75, 5, 10) 
plot_pick_metab(minipig_PCA, "CD4", "PC12", "PC12", 75, 5, 10) 
plot_pick_metab(minipig_PCA, "CD4_Tcell", "PC12", "PC12", 75, 5, 10) 
plot_pick_metab(minipig_PCA, "CD45RA", "PC4", "PC4", 75, 5, 10) 
plot_pick_metab(minipig_PCA, "Pop1", "PC1", "PC1", 5, 5, 10) 
plot_pick_metab(minipig_PCA, "Pop10", "PC4", "PC4", 5, 5, 10) 
plot_pick_metab(minipig_PCA, "Pop10", "PC5", "PC5", 5, 5, 10) 
plot_pick_metab(minipig_PCA, "Pop16", "PC12", "PC12", 5, 5, 10) 
plot_pick_metab(minipig_PCA, "Pop16", "PC4", "PC4", 5, 5, 10) 
plot_pick_metab(minipig_PCA, "Pop17", "PC13", "PC13", 5, 5, 10) 
plot_pick_metab(minipig_PCA, "Pop17", "PC14", "PC14", 5, 5, 10) 
plot_pick_metab(minipig_PCA, "Pop19", "PC1", "PC1", 5, 5, 10) 
plot_pick_metab(minipig_PCA, "Pop19", "PC4", "PC4", 5, 5, 10) 
plot_pick_metab(minipig_PCA, "Pop19", "PC5", "PC5", 5, 5, 10) 
plot_pick_metab(minipig_PCA, "Pop19", "PC6", "PC6", 5, 5, 10) 
plot_pick_metab(minipig_PCA, "Pop2", "PC16", "PC16", 5, 5, 10) 
plot_pick_metab(minipig_PCA, "Pop2", "PC2", "PC2", 5, 5, 10) 
plot_pick_metab(minipig_PCA, "Pop2", "PC7", "PC7", 5, 5, 10) 
plot_pick_metab(minipig_PCA, "Pop24", "PC1", "PC1", 5, 5, 10) 
plot_pick_metab(minipig_PCA, "Pop24", "PC3", "PC3", 5, 5, 10) 
plot_pick_metab(minipig_PCA, "Pop24", "PC4", "PC4", 5, 5, 10) 

```
Print more complex data
```{r}
plot_complex <- function(df, flow_pop, metab_pick, x_position, yposition1, yposition2) 
  {
fm1 <- df %>%
  filter(flow == flow_pop & PC == metab_pick) %>%
  lm(formula= PC_value ~ flow_percent *timepoint, data=.)

df3 <- df %>%
  filter(flow == flow_pop & PC == metab_pick) %>%
  cbind(pred = predict(fm1))
  
ggplot(data=df3, aes(x = flow_percent, y = PC_value, color = factor(timepoint))) + 
  geom_point() + 
  geom_line(mapping=aes(y=pred))  +
  ggtitle(metab_pick) +
  labs(color = "Timepoint", x = paste(flow_pop, "Percentage of Cells"), y = "PC Value", 
       fill = "Timepoint") 
}

plot_complex(minipig_PCA, "CD3", "PC11", 75, 5, 10) 
plot_complex(minipig_PCA, "CD3", "PC4",  75, 5, 10) 
plot_complex(minipig_PCA, "CD3", "PC5",  75, 5, 10) 
plot_complex(minipig_PCA, "CD4", "PC12",  75, 5, 10) 
plot_complex(minipig_PCA, "CD4_Tcell", "PC12",  75, 5, 10) 
plot_complex(minipig_PCA, "CD45RA", "PC4", 75, 5, 10) 
plot_complex(minipig_PCA, "Pop1", "PC1",  75, 5, 10) 
plot_complex(minipig_PCA, "Pop10", "PC4",  75, 5, 10) 
plot_complex(minipig_PCA, "Pop10", "PC5",  75, 5, 10) 
plot_complex(minipig_PCA, "Pop16", "PC12",  75, 5, 10) 
plot_complex(minipig_PCA, "Pop16", "PC4",  75, 5, 10) 
plot_complex(minipig_PCA, "Pop17", "PC13",  75, 5, 10) 
plot_complex(minipig_PCA, "Pop17", "PC14",  75, 5, 10) 
plot_complex(minipig_PCA, "Pop19", "PC1",  75, 5, 10) 
plot_complex(minipig_PCA, "Pop19", "PC4",  75, 5, 10) 
plot_complex(minipig_PCA, "Pop19", "PC5",  75, 5, 10) 
plot_complex(minipig_PCA, "Pop19", "PC6",  75, 5, 10) 
plot_complex(minipig_PCA, "Pop2", "PC16",  75, 5, 10) 
plot_complex(minipig_PCA, "Pop2", "PC2",  75, 5, 10) 
plot_complex(minipig_PCA, "Pop2", "PC7",  75, 5, 10) 
plot_complex(minipig_PCA, "Pop24", "PC1",  75, 5, 10) 
plot_complex(minipig_PCA, "Pop24", "PC3",  75, 5, 10) 
plot_complex(minipig_PCA, "Pop24", "PC4",  75, 5, 10) 

library(emmeans)
plot_complex(minipig_PCA, "CD3", "PC11", 75, 5, 10) 
plot_complex(minipig_PCA, "Pop10", "PC5",  75, 5, 10) 

fm1 <- minipig_PCA %>%
  filter(flow == "CD3" & PC == "PC11") %>%
  mutate(timepoint = recode_factor(timepoint, `1` = "12wks", `2` = "30DPI"))  %>%
  lm(formula = PC_value ~ timepoint *flow_percent , data = .)

#summary(fm1)

# try to find the difference in slopes
emtrends(fm1, pairwise ~ timepoint, var = "flow_percent")$contrasts %>%
  as.data.frame()

emtrends(fm1, pairwise ~ timepoint, var = "flow_percent")$emtrends %>%
  as.data.frame()

fm1 <- minipig_PCA %>%
  filter(flow == "Pop10" & PC == "PC5") %>%
  lm(formula = PC_value ~ timepoint *flow_percent , data = .)

#summary(fm1)
emtrends(fm1, pairwise ~ timepoint, var = "flow_percent")$contrasts %>%
  as.data.frame() 

minipig_PCA %>%
  filter(flow == "CD3" & PC == "PC11") %>%
  mutate(timepoint = recode_factor(timepoint, `1` = "12wks", `2` = "30DPI"))  %>%
  cbind(pred = predict(fm1))

test_trends <- function(df, flow_x, PC_n) {
  
  fm <- df %>%
  filter(flow == flow_x & PC == PC_n) %>%
  mutate(timepoint = recode_factor(timepoint, `1` = "12wks", `2` = "30DPI")) %>%
  lm(formula = PC_value ~ timepoint *flow_percent , data = .)

emtrends(fm, pairwise ~ timepoint, var = "flow_percent")$emtrends %>%
  as.data.frame() %>%
  mutate(flow = flow_x,
         PC = PC_n) 
}

test_trends(minipig_PCA, "CD3", "PC11") 
test_trends(minipig_PCA, "CD3", "PC4") 
test_trends(minipig_PCA, "CD3", "PC5") 
test_trends(minipig_PCA, "CD4", "PC12") 
test_trends(minipig_PCA, "CD4_Tcell", "PC12") 
test_trends(minipig_PCA, "Pop1", "PC1") 
test_trends(minipig_PCA, "Pop16", "PC12") 
test_trends(minipig_PCA, "Pop17", "PC13") 
test_trends(minipig_PCA, "Pop17", "PC14") 
test_trends(minipig_PCA, "Pop19", "PC1") 
test_trends(minipig_PCA, "Pop19", "PC5") 
test_trends(minipig_PCA, "Pop19", "PC6") 
test_trends(minipig_PCA, "Pop2", "PC16") 
test_trends(minipig_PCA, "Pop2", "PC2") 
test_trends(minipig_PCA, "Pop2", "PC7") 
test_trends(minipig_PCA, "Pop24", "PC1") 
test_trends(minipig_PCA, "Pop24", "PC3") 


# good 
test_trends(minipig_PCA, "CD45RA", "PC4") 
test_trends(minipig_PCA, "Pop10", "PC4") 
test_trends(minipig_PCA, "Pop10", "PC5") 
test_trends(minipig_PCA, "Pop16", "PC4") 
test_trends(minipig_PCA, "Pop19", "PC4") 
test_trends(minipig_PCA, "Pop24", "PC4") 


cell <- list(flow_x = c("CD3", "CD3","CD3","CD4", "CD4_Tcell", "Pop1", "Pop16", rep("Pop17", 2), rep("Pop19", 3), rep("Pop2", 3), rep("Pop24",2), "CD45RA", "Pop10", "Pop10", "Pop16", "Pop19", "Pop24"), PC_n = c("PC11", "PC4", "PC5", "PC12", "PC12", "PC1", "PC12", "PC13", "PC14", "PC1", "PC5", "PC6", "PC16", "PC2", "PC7", "PC1", "PC3", "PC4", "PC4", "PC5", rep("PC4", 3)))

ajk <-pmap(cell, function(flow_x,PC_n) test_trends(minipig_PCA, flow_x, PC_n))

do.call(rbind, ajk) %>%
  select(flow, PC, flow_percent.trend, timepoint) %>%
  pivot_wider(names_from = "timepoint", values_from = "flow_percent.trend") %>%
  mutate(change = `12wks`/`30DPI`) %>%
  filter(change <=2 & change >= 0.25) # it's okay that we're removing values with negative change because we're moving those that ahve opposing relationships
  
```
if timepoint = D30
PCvalue = -63.3395 + 0.7782*flow_percent + 54.4915*timepoint -0.6794*(flow_percent*timepoint)

if timepoint = 12 wks
PCvalue = -63.3395 + 0.7782*flow_percent + 54.4915 -0.6794*(flow_percent)

```{r}
-63.3395 + 54.4915*timepoint +  0.7782*flow_percent + -0.6794*timepoint*flow_percent


# 12 wks - goal to get 6.739
x = 90.04713
y = 1

# D30 DPI - goal to get -0.7348
x = 82.04493
y = 2

 (0.7782*x) + (54.4915*y) -63.3395  -0.6794*(x*y)



```


Because PC2 is correlated with flow, figure out which metabolites are contributing to PC2
```{r}

dim(res.pca$rotation)
dim(metabolite_wide)

# confirm that the $rotation is giving us the "importance/weight" of each metabolite
res.pca$rotation[,1] * metabolite_wide[1, ]
res.pca$rotation[ ,1] %*% as.matrix(scale(metabolite_wide[1, ]))

# arrange according to increasing and decreasing importance (note that high + and low - have high importance, those close to 0 have low importance)
res.pca$rotation %>%
  data.frame() %>%
  arrange(PC2)

# plot to see where I should cluster
res.pca$rotation %>%
  data.frame() %>%
  ggplot(aes(x = PC2)) +
  geom_histogram(bins = 50) +
  ylab("Weight of Molecular Features")

# maybe a cluster at >0.02 and < -0.1

# 115 metabolites - revised = 113
cluster1 <- res.pca$rotation %>%
  data.frame() %>%
  filter(PC2 >= 0.02) %>%
  rownames_to_column("metaboliteID") %>%
  mutate(metaboliteID = as.numeric(metaboliteID)) %>%
  select(metaboliteID, PC2)

cluster1_0.3 <- res.pca$rotation %>%
  data.frame() %>%
  filter(PC2 >= 0.03) %>%
  rownames_to_column("metaboliteID") %>%
  mutate(metaboliteID = as.numeric(metaboliteID)) %>%
  select(metaboliteID, PC2)

# 915 metabolites - revised = 954
cluster2_0.2 <- res.pca$rotation %>%
  data.frame() %>%
  filter(PC2 <= -0.02)%>%
  rownames_to_column("metaboliteID") %>%
  mutate(metaboliteID = as.numeric(metaboliteID)) %>%
  select(metaboliteID, PC2)

# 1413 metabolites
cluster2_0.1 <- res.pca$rotation %>%
  data.frame() %>%
  filter(PC2 <= -0.01)%>%
  rownames_to_column("metaboliteID") %>%
  mutate(metaboliteID = as.numeric(metaboliteID)) %>%
  select(metaboliteID, PC2)


# revised is when I use the "ZeroVar" function instead of removing any rows with 0 for a value
 # left_join(cluster1, match_metabolites) %>%
 #   write.csv("../data/saved_data/PCA/revised_cluster1_metab_list.csv")
 # 
 # left_join(cluster2_0.2, match_metabolites) %>%
 #   write.csv("../data/saved_data/PCA/revised_cluster2_0.2_metab_list.csv")
 # 
 # left_join(cluster2_0.1, match_metabolites) %>%
 #   write.csv("../data/saved_data/PCA/revised_cluster2_0.1_metab_list.csv")
 # 
 # left_join(cluster1_0.3, match_metabolites) %>%
 #  write.csv("../data/saved_data/PCA/revised_cluster1_0.3_metab_list.csv")
```

PC4
```{r}
# plot to see where I should cluster
res.pca$rotation %>%
  data.frame() %>%
  ggplot(aes(x = PC4)) +
  geom_histogram(bins = 50) +
  geom_vline(xintercept = 0.03, color = "red") +
  geom_vline(xintercept = -0.03, color = "red") +
  ylab("Weight of Molecular Features")

# 140 metabolites
PC4_cluster1 <- res.pca$rotation %>%
  data.frame() %>%
  filter(PC4 >= 0.03) %>%
  rownames_to_column("metaboliteID") %>%
  mutate(metaboliteID = as.numeric(metaboliteID)) %>%
  select(metaboliteID, PC4)

# 171 metabolites
PC4_cluster2 <- res.pca$rotation %>%
  data.frame() %>%
  filter(PC4 <= -0.03) %>%
  rownames_to_column("metaboliteID") %>%
  mutate(metaboliteID = as.numeric(metaboliteID)) %>%
  select(metaboliteID, PC4)

left_join(PC4_cluster1, match_metabolites) %>%
   write.csv("../data/saved_data/PCA/PC4_cluster1_metab_list.csv")

left_join(PC4_cluster2, match_metabolites) %>%
   write.csv("../data/saved_data/PCA/PC4_cluster2_metab_list.csv")
```

```{r}
# plot to see where I should cluster
res.pca$rotation %>%
  data.frame() %>%
  ggplot(aes(x = PC5)) +
  geom_histogram(bins = 50) +
    geom_vline(xintercept = 0.03, color = "red") +
  geom_vline(xintercept = -0.03, color = "red") +
  ylab("Weight of Molecular Features")

# 92 metabolites
PC5_cluster1 <- res.pca$rotation %>%
  data.frame() %>%
  filter(PC5 >= 0.03) %>%
  rownames_to_column("metaboliteID") %>%
  mutate(metaboliteID = as.numeric(metaboliteID)) %>%
  select(metaboliteID, PC5)

# 171 metabolites
PC5_cluster2 <- res.pca$rotation %>%
  data.frame() %>%
  filter(PC5 <= -0.03) %>%
  rownames_to_column("metaboliteID") %>%
  mutate(metaboliteID = as.numeric(metaboliteID)) %>%
  select(metaboliteID, PC5)

left_join(PC5_cluster1, match_metabolites) %>%
   write.csv("../data/saved_data/PCA/PC5_cluster1_metab_list.csv")

left_join(PC5_cluster2, match_metabolites) %>%
   write.csv("../data/saved_data/PCA/PC5_cluster2_metab_list.csv")
```

